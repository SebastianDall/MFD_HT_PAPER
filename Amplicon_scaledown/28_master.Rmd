---
title: "Amplicon diversity of MFD standard samples 2.0"
author: "Thomas Bygh Nymann Jensen, Thomas Y. Michaelsen"
date: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

```{r setup, include=FALSE}
library(knitr)
library(here)
knitr::opts_chunk$set(
  echo    = F,
  # fig.pos = "H",
  message = FALSE,
  warning = FALSE
)

setwd(here("Amplicon_scaledown"))

# Load the needed packages.
library(data.table)
library(readxl)
library(tidyverse)
library(ampvis2)
library(vegan)
library(patchwork)
library(ggpubr)
library(rlist)
library(DESeq2)

### Load and tidy ###
source("loaddata.R", encoding = "UTF-8")
colors <- c("grey", "darkgoldenrod2", "royalblue4", "seagreen", "salmon", "purple")

### Load plot functions and theme
source("../article_theme.R")
source("./functions.R")
```


## Filter Data
```{r}
dat_types <- load_datraw() %>%
  amp_subset_samples(!Soil_type %in% c("Blank", "Activated sludge") & !is.na(Kit))
```

```{r create data subsets}
# Create subsets
dat_types_sub4000 <- amp_subset_samples(dat_types, minreads = 4000)
dat_types_sub4000_ra <- amp_subset_samples(dat_types_sub4000, rarefy = min(colSums(dat_types_sub4000$abund)))
dat_types_sub4000_ra_rel_0.1 <- filter_otus(dat_types_sub4000_ra, 0.1)

dat_types_sub8000 <- amp_subset_samples(dat_types, minreads = 8000, !Soil_type == "Beach Sand")
dat_types_sub8000_ra <- amp_subset_samples(dat_types_sub8000, rarefy = min(colSums(dat_types_sub8000$abund)), !Soil_type == "Beach Sand")
```

### Bray Curtis variation
```{r}
bray_with_metadata <- calculate_bray_distance(dat_types_sub4000_ra_rel_0.1)

bray_variation_protocol <- bray_with_metadata %>%
  filter(SeqID != comparison) %>%
  filter(paste0(Protocol, Soil_type) == paste0(compared_protocol, compared_soil)) %>%
  filter(!duplicated(paste0(pmax(SeqID, comparison), pmin(SeqID, comparison)))) %>%
  group_by(Soil_type, Protocol) %>%
  summarise(
    mean_bray = format(round(mean(value, na.rm = TRUE), 2), nsmall = 2),
    sd_bray = format(round(sd(value, na.rm = TRUE), 2), nsmall = 2)
  )

bray_variation_between_protocols <- bray_with_metadata %>%
  filter(SeqID != comparison, Protocol != compared_protocol) %>%
  filter(Soil_type == compared_soil) %>%
  filter(!duplicated(paste0(pmax(SeqID, comparison), pmin(SeqID, comparison)))) %>%
  group_by(Soil_type) %>%
  summarise(
    mean_bray = format(round(mean(value, na.rm = TRUE), 2), nsmall = 2),
    sd_bray = format(round(sd(value, na.rm = TRUE), 2), nsmall = 2),
    bray_between = paste0(mean_bray, " (", sd_bray, ")")
  ) %>%
  mutate(Protocol = "2 x 25 µL") %>%
  select(Soil_type, Protocol, bray_between)
```


```{r}
lab_metadata <- load_ampLibConc() %>%
  mutate(SeqID = str_replace(SeqID, "_", "-")) %>%
  select(SeqID, PCR2)


rarefied_alphadiversity <- dat_types_sub4000_ra %>%
  amp_alphadiv(
    measure = c("observed", "shannon", "simpson"),
    richness = T
  ) %>%
  select(
    SeqID,
    Soil_type,
    Protocol,
    Shannon
  )

combine_alpha_beta_with_metadata <- rarefied_alphadiversity %>%
  # add library_concentration
  left_join(lab_metadata) %>%
  # Calculate failed libraries
  group_by(Soil_type, Protocol) %>%
  mutate(libs = n()) %>%
  # Calculate mean and sd for all numeric varaibles.
  summarise(
    across(where(is.numeric), .fns = list(mean = ~ mean(., na.rm = T), sd = ~ sd(., na.rm = T)), .names = "{.fn}_{.col}")
  ) %>%
  # Format mean and sd
  ungroup() %>%
  mutate(
    libs = as.character(mean_libs),
    across(where(is.numeric), ~ format(round(., 2), nsmall = 2))
  ) %>%
  left_join(bray_variation_protocol) %>%
  arrange(Soil_type, Protocol) %>%
  select(-c(sd_libs, mean_libs))


mean_sd_table <- combine_alpha_beta_with_metadata %>%
  pivot_longer(cols = -c(Soil_type, Protocol, libs, contains("sd")), names_to = "mean", values_to = "mean_value", names_prefix = "mean_") %>%
  pivot_longer(cols = -c(Soil_type, Protocol, libs, contains("mean")), names_to = "sd", values_to = "sd_value", names_prefix = "sd_") %>%
  group_by(Soil_type, Protocol) %>%
  # Filter for wrong match
  filter(mean == sd) %>%
  # Paste mean (sd)
  mutate(
    mean_sd = paste0(mean_value, " (", sd_value, ")")
  ) %>%
  select(!mean_value:sd_value) %>%
  # make wide and add bray variation between protocols
  pivot_wider(names_from = mean, values_from = mean_sd) %>%
  left_join(bray_variation_between_protocols) %>%
  # Remove duplicate Soil type
  group_by(Soil_type) %>%
  mutate_at(vars(Soil_type), ~ replace(., duplicated(.), "")) %>%
  mutate(bray_between = if_else(is.na(bray_between), "", bray_between)) %>%
  # Relocate columns
  relocate(PCR2, .after = libs)


names <- tibble(
  old_names = colnames(mean_sd_table),
  new_names = c("Soil type", "Protocol", "Libraries", "Library Conc.\n[ng/µL]", "Shannon\nDiversity", "Bray-Curtis\nVariation", "Bray-Curtis Variation\nBetween protocols") # "Site name", "Longitude Latitude", "Environment",
)

final_table <- mean_sd_table %>%
  rename_at(vars(names$old_names), ~ names$new_names)


hjustification_matrix <- as.vector(matrix(c(0, 0, 1, 1, 1, 1, 1), ncol = ncol(mean_sd_table), nrow = nrow(mean_sd_table), byrow = TRUE))
xjustification_matrix <- as.vector(matrix(c(0.1, 0.1, 0.9, 0.9, 0.9, 0.9, 0.9), ncol = ncol(mean_sd_table), nrow = nrow(mean_sd_table), byrow = TRUE))


alpha_table <- final_table %>%
  ggtexttable(rows = NULL, theme = ttheme(colnames.style = colnames_style(fill = "white"), tbody.style = tbody_style(fill = "white", hjust = hjustification_matrix, x = xjustification_matrix))) %>%
  tab_add_hline(at.row = 1:2, row.side = "top", linewidth = 2) %>%
  tab_add_hline(at.row = seq(4, 10, 2), row.side = "top", linewidth = 1)
```


And then for `Shannon`:
```{r}
shapiro.test(rarefied_alphadiversity$Shannon) # Data is not normally distributed

rarefied_alphadiversity %>%
  ggplot(aes(x = Shannon)) +
  geom_histogram(bins = 10)

ggqqplot(rarefied_alphadiversity, x = "Shannon")

anova.shannon <- anova(lm(Shannon ~ Protocol + Soil_type, data = rarefied_alphadiversity)) %>%
  data.frame() %>%
  rownames_to_column("Variable") %>%
  mutate(R2 = Sum.Sq / sum(Sum.Sq)) %>%
  mutate(across(R2, ~ round(., digits = 2))) %>%
  mutate(pval = ifelse(Pr..F. < 0.001, "<0.001", round(Pr..F., 2))) %>%
  select(Variable, R2, pval) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)

temp <- rarefied_alphadiversity %>%
  group_by(Protocol, Soil_type) %>%
  summarise(mean_div = mean(Shannon))
```



#### Heatmap

```{r heatmap}
phyla.text <- dat_types_sub4000 %>%
  amp_heatmap(
    group_by = c("Kit"),
    tax_aggregate = "Phylum",
    measure = "median",
    tax_show = 7000,
    normalise = FALSE,
    textmap = TRUE
  ) %>%
  mutate(total = rowSums(.)) %>%
  select(total) %>%
  arrange(desc(total)) %>%
  dplyr::slice(1:20) %>%
  rownames(.)

heatmap <- dat_types_sub4000 %>%
  amp_heatmap(
    facet_by = "Soil_type",
    group_by = "Protocol",
    tax_aggregate = "Phylum",
    # tax_add = c("Phylum"),
    tax_show = phyla.text,
    plot_values = FALSE,
    color_vector = c("salmon", "white", "royalblue4")
  ) +
  labs(
    x = "",
    y = "",
    title = "Heatmap aggregated at the phylum level across kits and sample types"
  ) +
  articletheme +
  theme(legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "right"))


# heatmap
```


```{r}
gg_table_dummy <- ggarrange(alpha_table, NULL, nrow = 2, ncol = 1, heights = c(1, 0.8))
p <- ggarrange(gg_table_dummy, heatmap, ncol = 2, labels = c("A", "B"), widths = c(1.2, 1))

ggsave(here("Amplicon_scaledown", "figures", "heatmap_alpha_div_v2.png"), device = "png", width = 15, height = 7, plot = p)
```

#### Ordination
```{r ordination}
soil <- unique(dat_types_sub4000_ra$metadata$Soil_type)

plot_soil_ord <- function(soil) {
  plotAmpliconOrdinationSoil(dat_types_sub4000_ra, soil, ord_type = "PCA")
}

plot_list <- map(soil, plot_soil_ord)

ggleg <- plot_list[[1]] + theme(legend.position = "right")

leg <- list(get_legend(ggleg))

plot_list2 <- append(plot_list, leg)

p <- ggarrange(plotlist = plot_list2, nrow = 2, ncol = ceiling(length(plot_list) / 2), labels = toupper(letters[1:5]))
```

```{r anosim}
otu <- dat_types_sub4000_ra$abund %>%
  t() %>%
  decostand(method = "hellinger")

otu.dist <- dat_types_sub4000_ra$abund %>%
  mutate(across(where(is.numeric), ~ . / sum(.))) %>%
  t() %>%
  decostand(method = "hellinger")

permanova <- adonis2(otu.dist ~ Protocol + Soil_type, data = dat_types_sub4000_ra$metadata, permutations = 999, method = "bray")

permanova %>%
  rownames_to_column("Variable") %>%
  mutate(across(3:6, ~ round(., digits = 3))) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)

dist <- vegdist(otu, method = "bray")
anova(betadisper(dist, dat_types_sub4000_ra$metadata$Protocol))

anosim <- anosim(otu, grouping = dat_types_sub4000_ra$metadata$Protocol, permutations = 999, distance = "bray")

print(anosim)
```

#### Rel abundance correlation plot
> Next chunk merges replicates and sample type. It needs to be one plot per soil type

```{r}
soil <- unique(dat_types$metadata$Soil_type)

deseq_results <- tibble(soil = soil) %>%
  mutate(deseq = map(.x = soil, .f = ~ deseq_function(.x)))

deseq_results_dataframe <- list.rbind(deseq_results$deseq) %>%
  mutate(
    pval_signif = if_else(padj < 0.05, TRUE, FALSE),
    fc_signif = if_else(abs(log2FoldChange) > 1, TRUE, FALSE),
  )
```


```{r}
dat_types_filtered_0.1 <- dat_types %>%
  filter_otus(0.1)

metadata <- dat_types$metadata %>%
  mutate(Protocol = str_replace(Protocol, "µ", "u"))
otu <- dat_types_filtered_0.1$abund

ProtocolDifferentialAbundance <- combine_otu_w_metadata(metadata = metadata, otu = otu) %>%
  summarise_triplicates() %>%
  calculate_relative_abundance() %>%
  filter_double_zeros() %>%
  left_join(deseq_results_dataframe) %>%
  mutate(
    Bias = if_else(log2FoldChange < 0 & pval_signif, "More abundant with 2 x 25 µL", if_else(pval_signif & log2FoldChange > 0, "More abundant with 2 x 5 µL", "Equally detected"))
  ) %>%
  filter(!is.na(Bias))
```

Note on p-values set to NA: some values in the results table can be set to NA for one of the following reasons:

* If within a row, all samples have zero counts, the baseMean column will be zero, and the log2 fold change estimates, p value and adjusted p value will all be set to NA.
* If a row contains a sample with an extreme count outlier then the p value and adjusted p value will be set to NA. These outlier counts are detected by Cook’s distance. Customization of this outlier filtering and description of functionality for replacement of outlier counts and refitting is described below
* If a row is filtered by automatic independent filtering, for having a low mean normalized count, then only the adjusted p value will be set to NA. Description and customization of independent filtering is described below
`NAs can be omitted by setting independentFiltering = FALSE, cooksCutoff = FALSE`






```{r}
plot_list <- map(.x = soil, ~ plotDiffRelabund(metadata_otu_combined_summarized_trip_wide_protocol, .x))

ggleg <- plot_list[[5]] + theme(legend.position = "right")

leg <- list(get_legend(ggleg))

plot_list2 <- append(plot_list, leg)

p <- ggarrange(plotlist = plot_list2, nrow = 2, ncol = ceiling(length(plot_list) / 2), labels = toupper(letters[1:5]))
p
```

```{r}
ggsave("./figures/diff_abundance_panel.png", plot = p, height = 13, width = 15, device = "png")
```


```{r}
# for(s in soil){
#   print(s)

#   p <- plotDiffRelabund(metadata_otu_combined_summarized_trip_wide_protocol, s)
#   ggsave(here("Amplicon_scaledown", "figures", paste0("diffrelabund_",s,".png")), plot = p, device = "png", width = 8, height = 7)

# }
```


#### Plot with ordination, differential, relative abundance, and distance matrix

```{r}
gg_arranged_ordination <- ggarrange(ordination_CA_relabfil_0.1_all, ordination_CA_relabfil_0.1_no_beachsand, labels = c("A", "B"), common.legend = T, legend = "bottom")
gg_diff_dist <- ggarrange(gg_bray_dist_matrix, ggdiff_clay, labels = c("C", "D"), ncol = 2, widths = c(1, 0.8))
ggarrange(gg_arranged_ordination, gg_diff_dist, nrow = 2)

ggsave(here("Amplicon_scaledown", "figures", "ordination_bray_diff_combined_v2.png"), device = "png", height = 13, width = 16)
```

