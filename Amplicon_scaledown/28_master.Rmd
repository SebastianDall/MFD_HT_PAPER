---
title: "Amplicon diversity of MFD standard samples 2.0"
author: "Thomas Bygh Nymann Jensen, Thomas Y. Michaelsen"
date: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

```{r setup, include=FALSE}
library(knitr)
library(here)
knitr::opts_chunk$set(
  echo    = F,
  # fig.pos = "H",
  message = FALSE,
  warning = FALSE
)

setwd(here("Amplicon_scaledown"))

# Load the needed packages.
library(data.table)
library(readxl)
library(tidyverse)
library(ampvis2)
library(vegan)
library(patchwork)
library(ggpubr)
library(rlist)
library(DESeq2)

### Load and tidy ###
source("loaddata.R")
colors <- c("grey", "darkgoldenrod2", "royalblue4", "seagreen", "salmon", "purple")

### Load plot functions and theme
source("../article_theme.R")
source("./functions.R")
```


## Filter Data
```{r}
dat_types <- datraw %>%
  amp_subset_samples(!Soil_type %in% c("Blank", "Activated sludge") & !is.na(Kit))
```

```{r create data subsets}
# Create subsets
dat_types_sub4000 <- amp_subset_samples(dat_types, minreads = 4000)
dat_types_sub4000_ra <- amp_subset_samples(dat_types_sub4000, rarefy = min(colSums(dat_types_sub4000$abund)))
dat_types_sub4000_ra_rel_0.1 <- filter_otus(dat_types_sub4000_ra, 0.1)

dat_types_sub8000 <- amp_subset_samples(dat_types, minreads = 8000, !Soil_type == "Beach Sand")
dat_types_sub8000_ra <- amp_subset_samples(dat_types_sub8000, rarefy = min(colSums(dat_types_sub8000$abund)), !Soil_type == "Beach Sand")
```

### Bray Curtis variation
```{r}
tax_data_rel_0.1 <- dat_types_sub4000_ra_rel_0.1$abund %>%
  t()

bray_distance <- as.matrix(vegdist(tax_data_rel_0.1)) %>%
  as.data.frame() %>%
  rownames_to_column("SeqID")

metadata <- dat_types_sub4000_ra_rel_0.1$metadata %>%
  select(SeqID, Sample_id, Protocol, Soil_type)

metadata_renamed <- metadata %>%
  dplyr::rename(
    comparison = SeqID,
    compared_soil = Soil_type,
    compared_protocol = Protocol
  ) %>%
  select(-Sample_id)

bray_with_metadata <- metadata %>%
  left_join(bray_distance) %>%
  pivot_longer(!SeqID:Soil_type, names_to = "comparison", "value") %>%
  left_join(metadata_renamed, by = "comparison")

bray_variation_protocol <- bray_with_metadata %>%
  filter(SeqID != comparison) %>%
  filter(paste0(Protocol, Soil_type) == paste0(compared_protocol, compared_soil)) %>%
  filter(!duplicated(paste0(pmax(SeqID, comparison), pmin(SeqID, comparison)))) %>%
  group_by(Soil_type, Protocol) %>%
  summarise(
    mean_bray = format(round(mean(value, na.rm = TRUE), 2), nsmall = 2),
    sd_bray = format(round(sd(value, na.rm = TRUE), 2), nsmall = 2)
  )

bray_variation_between_protocols <- bray_with_metadata %>%
  filter(SeqID != comparison, Protocol != compared_protocol) %>%
  filter(Soil_type == compared_soil) %>%
  filter(!duplicated(paste0(pmax(SeqID, comparison), pmin(SeqID, comparison)))) %>%
  group_by(Soil_type) %>%
  summarise(
    mean_bray = format(round(mean(value, na.rm = TRUE), 2), nsmall = 2),
    sd_bray = format(round(sd(value, na.rm = TRUE), 2), nsmall = 2)
  )
```


And then for `Shannon`:
```{r}
tmp1 <- filter(div_multicomp, index %in% "Shannon")

anova.shannon <- anova(lm(diversity ~ Protocol + Soil_type, data = tmp1)) %>%
  data.frame() %>%
  rownames_to_column("Variable") %>%
  mutate(R2 = Sum.Sq / sum(Sum.Sq)) %>%
  mutate(across(R2, ~ round(., digits = 2))) %>%
  mutate(pval = ifelse(Pr..F. < 0.001, "<0.001", round(Pr..F., 2))) %>%
  select(Variable, R2, pval) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)

temp <- tmp1 %>%
  group_by(Protocol, Soil_type) %>%
  summarise(mean_div = mean(diversity))

result <- t.test(mean_div ~ Protocol, data = temp)$p.value %>%
  signif(., digits = 3)

result
```



```{r}
tabReads <- merge(
  dat_types$metadata,
  data.frame(NumReads = apply(dat_types$abund, 2, sum)),
  by = 0
)

numberOfReads <- tabReads %>%
  select(SeqID, Soil_type, Kit, NumReads)

alpha_div_subs4000_ra <- dat_types_sub4000_ra %>%
  amp_alphadiv(
    measure = c("observed", "shannon", "simpson"),
    richness = T
  ) %>%
  select(
    SeqID,
    Soil_type,
    Protocol,
    ObservedOTUs,
    Shannon
  )

alpha_div_subs4000_ra_summarised <- alpha_div_subs4000_ra %>%
  left_join(numberOfReads) %>%
  group_by(Soil_type, Protocol) %>%
  mutate(failed_lib = 3 - n()) %>%
  summarise(
    meanReads = round(mean(NumReads)),
    # sdReads = sd(NumReads),
    meanOTU = round(mean(ObservedOTUs), 0),
    sdOTU = sd(ObservedOTUs),
    mean_shannon = mean(Shannon),
    sdShannon = sd(Shannon),
    failed_lib = max(failed_lib)
  ) %>%
  ungroup() %>%
  mutate(across(where(is.numeric), ~ round(., 2)))
arrange(Soil_type, Protocol)

hjustification_matrix <- as.vector(matrix(c(0, 0, 1, 1, 1, 1, 1, 1), ncol = 8, nrow = nrow(alpha_div_subs4000_ra_summarised), byrow = TRUE))
xjustification_matrix <- as.vector(matrix(c(0.1, 0.1, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9), ncol = 8, nrow = nrow(alpha_div_subs4000_ra_summarised), byrow = TRUE))


alpha_table <- alpha_div_subs4000_ra_summarised %>%
  mutate(Soil_type = if_else(Protocol == "2 x 5 ÂµL", "", Soil_type)) %>%
  relocate(failed_lib, .after = Protocol) %>%
  rename(`Soil Type` = Soil_type, `Mean\nReads` = meanReads, `Mean\nASVs` = meanOTU, `Sd\nASVs` = sdOTU, `Mean\nShannon` = mean_shannon, `Sd\nShannon` = sdShannon, `Failed\nLibraries` = failed_lib) %>%
  ggtexttable(rows = NULL, theme = ttheme(colnames.style = colnames_style(fill = "white"), tbody.style = tbody_style(fill = "white", hjust = hjustification_matrix, x = xjustification_matrix))) %>%
  tab_add_hline(at.row = 1:2, row.side = "top", linewidth = 2) %>%
  tab_add_hline(at.row = seq(4, 10, 2), row.side = "top", linewidth = 1)
```



#### Heatmap

```{r heatmap}
phyla.text <- dat_types_sub4000 %>%
  amp_heatmap(
    group_by = c("Kit"),
    tax_aggregate = "Phylum",
    measure = "median",
    tax_show = 7000,
    normalise = FALSE,
    textmap = TRUE
  ) %>%
  mutate(total = rowSums(.)) %>%
  select(total) %>%
  arrange(desc(total)) %>%
  dplyr::slice(1:20) %>%
  rownames(.)

heatmap <- dat_types_sub4000 %>%
  amp_heatmap(
    facet_by = "Soil_type",
    group_by = "Protocol",
    tax_aggregate = "Phylum",
    # tax_add = c("Phylum"),
    tax_show = phyla.text,
    plot_values = FALSE,
    color_vector = c("salmon", "white", "royalblue4")
  ) +
  labs(
    x = "",
    y = "",
    title = "Heatmap aggregated at the phylum level across kits and sample types"
  ) +
  articletheme +
  theme(legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "right"))


heatmap
```


```{r}
gg_table_dummy <- ggarrange(alpha_table, NULL, nrow = 2, ncol = 1, heights = c(1, 0.9))
ggarrange(heatmap, gg_table_dummy, ncol = 2, labels = c("A", "B"), widths = c(1.4, 1))

ggsave(here("Amplicon_scaledown", "figures", "heatmap_alpha_div.png"), device = "png", width = 14, height = 7)
```

#### Ordination
```{r ordination}
soil <- unique(dat_types_sub4000_ra$metadata$Soil_type)

plot_soil_ord <- function(soil) {
  plotAmpliconOrdinationSoil(dat_types_sub4000_ra, soil, ord_type = "PCA")
}

plot_list <- map(soil, plot_soil_ord)

ggleg <- plot_list[[1]] + theme(legend.position = "right")

leg <- list(get_legend(ggleg))

plot_list2 <- append(plot_list, leg)

p <- ggarrange(plotlist = plot_list2, nrow = 2, ncol = ceiling(length(plot_list) / 2), labels = toupper(letters[1:5]))
```

```{r anosim}
otu <- dat_types_sub4000_ra$abund %>%
  t() %>%
  decostand(method = "hellinger")

otu.dist <- dat_types_sub4000_ra$abund %>%
  mutate(across(where(is.numeric), ~ . / sum(.))) %>%
  t() %>%
  decostand(method = "hellinger")

permanova <- adonis2(otu.dist ~ Protocol + Soil_type, data = dat_types_sub4000_ra$metadata, permutations = 999, method = "bray")

permanova %>%
  rownames_to_column("Variable") %>%
  mutate(across(3:6, ~ round(., digits = 3))) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)

dist <- vegdist(otu, method = "bray")
anova(betadisper(dist, dat_types_sub4000_ra$metadata$Protocol))

anosim <- anosim(otu, grouping = dat_types_sub4000_ra$metadata$Protocol, permutations = 999, distance = "bray")

print(anosim)
```

#### Distance heatmap
```{r distance matrix}
# otu_sub400_ra_hellinger <- dat_types_sub4000_ra$abund %>%
#   t() %>%
#   as.data.frame() %>%
#   abundance_filter(verbose = T) %>%
#   decostand(method = "hellinger")

# otu_sub400_ra_hellinger_bray_dist <- vegdist(otu_sub400_ra_hellinger, method = "bray", diag = T, upper = T)

# sample_names <- dat_types_sub4000_ra$metadata %>%
#   group_by(Soil_type, Protocol) %>%
#   mutate(Soil_type_sample = paste0(Soil_type, " - ", Protocol, " - ", row_number())) %>%
#   ungroup() %>%
#   select(SeqID, Soil_type_sample)

# otu_sub400_ra_hellinger_bray_dist_sample_names <- otu_sub400_ra_hellinger_bray_dist %>%
#   as.matrix() %>%
#   as.data.frame() %>%
#   rownames_to_column("SeqID") %>%
#   left_join(sample_names) %>%
#   relocate("Soil_type_sample", .after = "SeqID")

# colnames(otu_sub400_ra_hellinger_bray_dist_sample_names) <- c("SeqID", "Soil_type_sample", otu_sub400_ra_hellinger_bray_dist_sample_names$Soil_type_sample)

# otu_sub400_ra_hellinger_bray_dist_sample_names_long <- otu_sub400_ra_hellinger_bray_dist_sample_names %>%
#   pivot_longer(-c(SeqID, Soil_type_sample), names_to = "sample_id", values_to = "bray_dist")


# axiscolors <- otu_sub400_ra_hellinger_bray_dist_sample_names_long %>%
#   distinct(Soil_type_sample) %>%
#   arrange(Soil_type_sample) %>%
#   mutate(axiscolor = if_else(
#     str_detect(Soil_type_sample, "Beach Sand -"),
#     colors[1],
#     if_else(
#       str_detect(Soil_type_sample, "^Clay -"),
#       colors[2],
#       if_else(
#         str_detect(Soil_type_sample, "Organic -"),
#         colors[3],
#         if_else(
#           str_detect(Soil_type_sample, "Sand -"),
#           colors[4],
#           colors[5]
#         )
#       )
#     )
#   ))


# gg_bray_dist_matrix <- otu_sub400_ra_hellinger_bray_dist_sample_names_long %>%
#   ggplot(aes(x = Soil_type_sample, y = sample_id, fill = bray_dist)) +
#   geom_tile(color = "white") +
#   scale_fill_gradient(low = "black", high = "white") +
#   labs(x = "", y = "") +
#   articletheme +
#   labs(fill = "Dissimilarity", title = "Bray-Curtis Dissimilarity based on Hellinger transformed Relative Abundance") +
#   theme(
#     axis.text.x = element_text(face = "bold", color = axiscolors$axiscolor),
#     axis.text.y = element_text(face = "bold", color = axiscolors$axiscolor),
#     legend.position = "right"
#   )

# gg_bray_dist_matrix
```
```{r}
ggsave(here("Amplicon_scaledown", "figures", "hellinger_transformed_bray_curtis_dist_matrix.png"), device = "png", width = 12, height = 10)
```

#### Rel abundance correlation plot
> Next chunk merges replicates and sample type. It needs to be one plot per soil type

```{r}
soil <- unique(dat_types$metadata$Soil_type)

deseq_results <- tibble(soil = soil) %>%
  mutate(deseq = map(.x = soil, .f = ~ deseq_function(.x)))

dif_abundance <- list.rbind(deseq_results$deseq) %>%
  mutate(
    pval_signif = if_else(padj < 0.05, TRUE, FALSE),
    fc_signif = if_else(abs(log2FoldChange) > 1, TRUE, FALSE),
  )
```

  deseq <- DESeq(dds)
  res <- as.data.frame(results(deseq))
  res$Soil_type <- soil
  return(res)
}

deseq_results <- tibble(soil = soil) %>%
  mutate(deseq = map(.x = soil, .f = ~ deseq_function(.x)))

dif_abundance <- list.rbind(deseq_results$deseq) %>%
  mutate(
    pval_signif = if_else(padj < 0.05, TRUE, FALSE),
    fc_signif = if_else(abs(log2FoldChange) > 1, TRUE, FALSE),
  ) %>%
  rownames_to_column("OTU")
```


```{r}
dat_types_filtered_0.1 <- dat_types %>%
  filter_otus(0.1)

metadata <- dat_types$metadata
otu <- dat_types_filtered_0.1$abund

otu_long <- otu %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("SeqID") %>%
  pivot_longer(-SeqID, names_to = "OTU", values_to = "abund")

metadata_selected <- metadata %>%
  select(SeqID, Soil_type, Protocol)

metadata_otu_combined <- left_join(metadata_selected, otu_long)

# Summmarise triplicates
metadata_otu_combined_summarized_trip <- metadata_otu_combined %>%
  group_by(Soil_type, Protocol, OTU) %>%
  summarise(abund = round(mean(abund))) %>%
  group_by(Soil_type, Protocol) %>%
  mutate(
    total_abund = sum(abund, na.rm = TRUE),
    rel_abund = abund / total_abund * 100
  ) %>%
  select(-abund, -total_abund) %>%
  filter(OTU %in% rownames(dat_types_filtered_0.1$abund))

# Add DESeq2 data
metadata_otu_combined_summarized_trip_wide_protocol <- metadata_otu_combined_summarized_trip %>%
  relocate(OTU, .before = Protocol) %>%
  pivot_wider(names_from = Protocol, values_from = rel_abund) %>%
  dplyr::rename(Downscaled = `2 x 5 ÂµL`, Fullscale = `2 x 25 ÂµL`) %>%
  rowwise() %>%
  filter(sum(Fullscale, Downscaled) > 0) %>%
  left_join(dif_abundance) %>%
  mutate(
    Bias = if_else(log2FoldChange < 0 & pval_signif, "More abundant with 2 x 25 ÂµL", if_else(pval_signif & log2FoldChange > 0, "More abundant with 2 x 5 ÂµL", "Equally detected"))
  ) %>%
  filter(!is.na(Bias))
```

Note on p-values set to NA: some values in the results table can be set to NA for one of the following reasons:

* If within a row, all samples have zero counts, the baseMean column will be zero, and the log2 fold change estimates, p value and adjusted p value will all be set to NA.
* If a row contains a sample with an extreme count outlier then the p value and adjusted p value will be set to NA. These outlier counts are detected by Cookâs distance. Customization of this outlier filtering and description of functionality for replacement of outlier counts and refitting is described below
* If a row is filtered by automatic independent filtering, for having a low mean normalized count, then only the adjusted p value will be set to NA. Description and customization of independent filtering is described below







```{r}
plot_list <- map(.x = soil, ~ plotDiffRelabund(metadata_otu_combined_summarized_trip_wide_protocol, .x))

ggleg <- plot_list[[5]] + theme(legend.position = "right")

leg <- list(get_legend(ggleg))

plot_list2 <- append(plot_list, leg)

p <- ggarrange(plotlist = plot_list2, nrow = 2, ncol = ceiling(length(plot_list) / 2), labels = toupper(letters[1:5]))
p
```

```{r}
ggsave("./figures/diff_abundance_panel.png", plot = p, height = 13, width = 15, device = "png")
```


```{r}
# for(s in soil){
#   print(s)

#   p <- plotDiffRelabund(metadata_otu_combined_summarized_trip_wide_protocol, s)
#   ggsave(here("Amplicon_scaledown", "figures", paste0("diffrelabund_",s,".png")), plot = p, device = "png", width = 8, height = 7)

# }
```


#### Plot with ordination, differential, relative abundance, and distance matrix

```{r}
gg_arranged_ordination <- ggarrange(ordination_CA_relabfil_0.1_all, ordination_CA_relabfil_0.1_no_beachsand, labels = c("A", "B"), common.legend = T, legend = "bottom")
gg_diff_dist <- ggarrange(gg_bray_dist_matrix, ggdiff_clay, labels = c("C", "D"), ncol = 2, widths = c(1, 0.8))
ggarrange(gg_arranged_ordination, gg_diff_dist, nrow = 2)

ggsave(here("Amplicon_scaledown", "figures", "ordination_bray_diff_combined_v2.png"), device = "png", height = 13, width = 16)
```

