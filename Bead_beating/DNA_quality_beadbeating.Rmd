---
title: "Analysis of DNA quality as an effect of bead beating settings"
author: "Thomas Bygh Nymann Jensen"
datae: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

# This is code to replicate the analysis used for my HT paper
# The data includes Nanodrop, Qubit, ScreenTape, Extraction concentration

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE)

# Load the needed packages.
library(patchwork)
library(tidyverse)
colors <- c("royalblue4", "seagreen", "salmon")
colors2 <- c("#C6DBEF", "#4292C6", "#08306B")

# Load metadata.
meta <- readxl::read_excel("../Metadata/2022-10-13_metadata_beadbeating_exp.xlsx", sheet = 1, na = "NA") %>%
  mutate(across(Integrity, ~as.numeric(.))) %>%
  mutate(across(3:7, ~as.factor(.))) %>%
  filter(!RPM == 1000) %>%
  mutate(Beadbeating = str_c(RPM, Time, sep = ",")) %>%
  mutate(across(SeqID, ~str_replace(., "_", "-")))
```

Data removed for RPM = 1000 as results are bad - bead beating does not seem to work at this speed - stochastics?

# Extraction analysis

## DNA quality
A DNA sample with a 260/280 ratio of ~1.8 is considered "pure". A lower ratio suggest contamination by e.g. proteins (a large amount is needed to affect the ratio) or other reagents from the extraction protocol absorbing at 280 nm. The 260/230 ratio is used as a secondary measure and a value between ~2.0 and 2.2 is expexted for a pure sample. A lower ratio suggest contamination by humic substances or guanidine which absorbs at 220-230 nm. 

```{r, warning=FALSE, message=FALSE, out.width = '100%'}
# Calculation of basic statistics from replicates; mean and standard deviation.
df_quality <- meta %>%
  filter(Soil_type %in% c("Organic", "Clay", "Sand")) %>%
  group_by(Soil_type, RPM, Time) %>%
  summarise(`260/280_mean` = mean(`260/280`),
            `260/280_sd` = sd(`260/280`),
            `260/230_mean` = mean(`260/230`),
            `260/230_sd` = sd(`260/230`),
            `nanodrop_mean` = mean(`Conc_nanodrop`),
            `nanodrop_sd` = sd(`Conc_nanodrop`),
            `qubit_mean` = mean(`Conc_qubit`),
            `qubit_sd` = sd(`Conc_qubit`),
            `integrity_mean` = mean(Integrity, na.rm = TRUE) / 1000,
            `integrity_sd` = sd(Integrity, na.rm = TRUE) / 1000,
            `integrity_n` = sum(!is.na(Integrity))) %>%
  ungroup()


# plot of 260/280 ratio
plot_nanodrop_1 <- df_quality %>%
  ggplot(aes(x = RPM, y = `260/280_mean`, color = Time)) +
  geom_point(aes(size = qubit_mean), position = position_dodge(width = 0.5)) +
  geom_line(aes(group = Time), position = position_dodge(width = 0.5)) +
  scale_size_continuous(range = c(1, 3)) +
  geom_errorbar(aes(x = RPM, ymin = `260/280_mean` - `260/280_sd`, ymax = `260/280_mean` + `260/280_sd`),
                width = 0.3, size = 0.5, position = position_dodge(width = 0.5)) +
  #geom_hline(yintercept = 1.8) +
  facet_grid(cols = vars(Soil_type)) +
  labs(title = "260/280 ratio faceted by beadbeating intensity and duration",
       y = "Ratio",
       x = "Intensity [RPM]",
       color = "Duration [s]",
       size = "Concentration [ng/µL]") +
  scale_color_manual(values = colors2) +
  scale_y_continuous(limits = c(0, 2.2), breaks = c(seq(0, 2.2, 0.2))) +
  theme_bw(base_size = 10) +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        plot.margin = unit(c(0, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

# plot of 260/230 ratio
plot_nanodrop_2 <- df_quality %>%
  ggplot(aes(x = RPM, y = `260/230_mean`, color = Time)) +
  geom_point(aes(size = qubit_mean), position = position_dodge(width = 0.5)) +
  geom_line(aes(group = Time), position = position_dodge(width = 0.5)) +
  scale_size_continuous(range = c(1, 3)) +
  geom_errorbar(aes(x = RPM, ymin = `260/230_mean` - `260/230_sd`, ymax = `260/230_mean` + `260/230_sd`),
                width = 0.3, size = 0.5, position = position_dodge(width = 0.5)) +
  #geom_hline(yintercept = 2.2) +
  facet_grid(cols = vars(Soil_type)) +
  labs(title = "260/230 ratio faceted by beadbeating intensity and duration",
       y = "Ratio",
       x = "Intensity [RPM]",
       color = "Duration [s]",
       size = "Concentration [ng/µL]") +
  scale_color_manual(values = colors2) +
  scale_y_continuous(limits = c(0, 2.2), breaks = c(seq(0, 2.2, 0.2))) +
  theme_bw(base_size = 10) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        plot.margin = unit(c(1, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

# organize plots
plot_nanodrop_1 / plot_nanodrop_2

# plot of quantification by qubit 
plot_qubit_1 <- df_quality %>%
  ggplot(aes(x = Time, y = RPM, fill = qubit_mean)) +
  geom_tile() +
  facet_grid(cols = vars(Soil_type)) +
  geom_text(aes(label = paste(round(qubit_mean, 1), "\u00B1", round(qubit_sd, 1), "ng/µL")), size = 3) +
  scale_fill_gradient2(low = "#C6DBEF", mid = "#4292C6", high = "#08306B", midpoint = 25) +
  labs(
    title = "The effect of beadbeating on DNA concentration and integrity",
    y = "Intensity [RPM]",
    x = "Duration [s]",
    fill = "Concentration [ng/µL]") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw(base_size = 10) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        plot.margin = unit(c(1, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

# plot of integrity
plot_integrity_1 <- df_quality %>%
  ggplot(aes(x = Time, y = RPM, fill = integrity_mean)) +
  geom_tile() +
  facet_grid(cols = vars(Soil_type)) +
  geom_text(aes(label = paste(round(integrity_mean, 1), 
                              "\u00B1", round(integrity_sd, 1), "kbp\n", "n =", integrity_n)), size = 3) +
  scale_fill_gradient2(low = "#C6DBEF", mid = "#4292C6", high = "#08306B", midpoint = 15) +
  labs(
    title = "The effect of beadbeating on DNA integrity",
    y = "Intensity [RPM]",
    x = "Duration [s]",
    fill = "Integrity [kbp]") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw(base_size = 10) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        axis.title = element_blank(),
        plot.margin = unit(c(1, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

# organize plots
plot_qubit_1 / plot_integrity_1
```

### Anova - linear model

```{r, warning=FALSE, message=FALSE, out.width = '100%'}
# anova analysis 
aov_qubit <- aov(data = meta, 
                 Conc_qubit ~ Soil_type + Time * RPM + Soil_type * Time + Soil_type * RPM) %>%
  summary.aov() %>%
  print()

aov_integity <- aov(data = meta, 
                    Integrity ~ Soil_type + Time * RPM + Soil_type * Time + Soil_type * RPM) %>% 
  summary.aov() %>%
  print()

aov_260_280 <- aov(data = meta, 
                   `260/280` ~ Soil_type + Time * RPM + Soil_type * Time + Soil_type * RPM) %>%
  summary.aov() %>%
  print()

aov_260_230 <- 
  aov(data = meta, 
      `260/230` ~ Soil_type + Time * RPM + Soil_type * Time + Soil_type * RPM) %>%
  summary.aov() %>%
  print()
```

# Save plots
```{r}
tiff("nanodrop_ratios.tiff", units="in", width=5, height=5, res=300)
plot_nanodrop_1 / plot_nanodrop_2
dev.off()

png("nanodrop_ratios.png", width = 1600, height = 700) 
plot_nanodrop_1 / plot_nanodrop_2
dev.off()

tiff("heatmap_integrity_quantity.tiff", units="in", width=5, height=5, res=300)
plot_qubit_1 / plot_integrity_1
dev.off()

png("heatmap_integrity_quantity.png", width = 600, height = 300) 
plot_qubit_1 / plot_integrity_1
dev.off()

```


*Conclusions: The soils are affected differently by the different bead beating conditions. For the spectroscopic purity ratios a higher intensity seems to increase the value, however the measurement itself is only reliable when the concentration is above 20 ng/µL. For the Sand sample an intensity and duration below 1600 RPM and 240 s does not yield qunatifiable DNA. The Anova results suggets that the Concentration of DNA is affected by both duration and intensity whereas the integrity is only affected by the intensity. To maximise yield 1600 or 1800 RPM should be used for 6 minutes. However 1800 RPM results in fragments shorter than 10 kbp.*

# Plotting
```{r}
#Figur 1
design <- "
  133
  244
"

plot_nanodrop_1 + plot_nanodrop_2 + plot_qubit_1 + plot_integrity_1 + plot_layout(design = design, guides = "collect")
  #theme(legend.position = "right")

ggsave("beadbeating2.png", width = 15.36, height = 8.14, dpi = 600)
```



