---
title: "Analysis of DNA quality as an effect of bead beating settings"
author: "Thomas Bygh Nymann Jensen"
datae: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

# This is code to replicate the analysis used for my HT paper
# The data includes Nanodrop, Qubit, ScreenTape, Extaction and Library concentrations
# as well as amplicon V1-4 data

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

# Load the needed packages.
library(patchwork)
library(ampvis2)
library(data.table)
library(tidyverse)
library(here)
library(ggpubr)

setwd(here("Bead_beating"))

# Load data
source("loaddata.R")

# Load theme
source("../article_theme.R")

colors <- c("royalblue4", "seagreen", "salmon")
colors2 <- c("#C6DBEF", "#4292C6", "#08306B")
```

Data removed for RPM = 1000 as results are bad - bead beating does not seem to work at this speed.

# Amplicon analysis

## QC - samples

```{r}
dat_types <- amp_subset_samples(datraw, !Soil_type %in% c("Blank", "MIDAS") & !is.na(Kit))
# Create subsets
dat_types_sub4000 <- amp_subset_samples(dat_types, minreads = 4000)
dat_types_sub4000_ra <- amp_subset_samples(dat_types_sub4000, rarefy = min(colSums(dat_types_sub4000$abund)))
```

### Heatmap
```{r}
phyla.text <- dat_types_sub4000_ra %>%
  amp_heatmap(
    group_by = c("Project_id"),
    tax_aggregate = "Phylum",
    measure = "median",
    tax_show = 7000,
    normalise = FALSE,
    textmap = TRUE
  ) %>%
  mutate(total = rowSums(.)) %>%
  select(total) %>%
  arrange(desc(total)) %>%
  dplyr::slice(1:20) %>%
  rownames(.)

plot.heat_all <- dat_types_sub4000 %>%
  amp_heatmap(
    facet_by = c("Soil_type", "RPM"),
    group_by = "Time",
    tax_aggregate = "Phylum",
    tax_show = phyla.text,
    min_abundance = 0.1,
    plot_values = F,
    plot_values_size = 3,
    # order_y_by = order,
    color_vector = c("salmon", "white", "royalblue4")
  ) +
  labs(
    x = "",
    y = "",
    title = "Heatmap aggregated at phylum level across RPM and time"
  ) +
  articlethemex0

plot.heat_all
```

### Ordination


```{r}
plot_ordination <- function(soil) {
  gg <- dat_types_sub4000_ra %>%
    amp_subset_samples(Soil_type == soil) %>%
    amp_ordinate(
      filter_species = 0.05,
      type = "RDA",
      constrain = c("RPM", "Time"),
      transform = "none",
      species_plot = FALSE,
      # species_label_taxonomy = "Genus",
      # species_nlabels = 10,
      sample_color_by = "Time",
      sample_shape_by = "RPM",
      sample_colorframe = FALSE,
      sample_point_size = 5
    ) +
    geom_point(alpha = 0.5) +
    ggforce::geom_mark_ellipse(aes(group = RPM), alpha = 0.5, color = "black") +
    scale_color_manual(values = colors2) +
    # scale_shape_discrete(guide = "none") +
    labs(
      title = paste0("RDA constrained by RPM and Time - ", soil),
      color = "Time [s]",
      shape = "Intensity [RPM]"
    ) +
    # xlim(-10, 10) +
    # ylim(-10, 10) +
    guides(color = guide_legend(override.aes = list(size = 5, shape = 15))) +
    articlethemex0 +
    theme(legend.position = "none")
}
```

```{r}
soil <- unique(dat_types_sub4000_ra$metadata$Soil_type)

plot_list <- map(soil, plot_ordination)

plot_list[[3]] <- plot_list[[3]] + theme(legend.position = "right")


p <- ggarrange(plotlist = plot_list, nrow = 1, ncol = ceiling(length(plot_list)), labels = toupper(letters[2:4]), common.legend = TRUE, legend = "right")
p
```

```{r}
pf <- ggarrange(plot.heat_all, p, nrow = 2, labels = c("A", ""))

ggsave("./figures/beadbeating_heatmap_RDA.png", device = "png", width = 15, height = 13)
```


```{r}
metadata <- dat_types_sub4000_ra$metadata

alpha <- dat_types_sub4000_ra %>%
  amp_alpha_diversity(measure = c("observed", "shannon", "simpson"), richness = TRUE) %>%
  select(Time, RPM, Soil_type, Shannon)

metadata_w_alpha_long <- metadata %>%
  left_join(alpha) %>%
  select(SeqID, Sample_id, Soil_type, RPM, Time, `260_280`:Conc_qubit, Integrity, Shannon) %>%
  pivot_longer(-c(SeqID:Time), names_to = "variable", values_to = "value")


var <- unique(metadata_w_alpha_long$variable)[c(3, 1, 2, 4, 5)]

metrics <- tibble(
  variable = var,
  explanation = c("260/280 ratio", "260/230 ratio", "Qubit [ng/ÂµL]", "Fragment Length [Kbp]", "Shannon Diversity")
)

metadata_w_alpha_long_summarised <- metadata_w_alpha_long %>%
  group_by(Soil_type, RPM, Time, variable) %>%
  summarise(mean = mean(value), sd = sd(value)) %>%
  left_join(metrics)

plot_experiment_metrics <- function(var) {
  dodge <- 0.75

  df <- metadata_w_alpha_long_summarised %>%
    filter(variable == var)

  explanation <- unique(df$explanation)

  gg <- metadata_w_alpha_long_summarised %>%
    filter(variable == var) %>%
    ggplot(aes(x = RPM, y = mean, color = Time, group = interaction(Soil_type, Time))) +
    geom_point(size = 5, alpha = 0.5, position = position_dodge(dodge)) +
    geom_line(position = position_dodge(dodge)) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd, width = .2), position = position_dodge(dodge)) +
    facet_grid(~Soil_type, space = "free_y") +
    labs(
      title = paste0(explanation),
      x = "",
      y = ""
    ) +
    articletheme +
    theme(legend.position = "none")

  return(gg)
}
```

```{r}
plot_list <- map(var, plot_experiment_metrics)

ggleg <- plot_list[[1]] + theme(legend.position = "right")

leg <- list(get_legend(ggleg))

plot_list2 <- append(plot_list, leg)

p <- ggarrange(plotlist = plot_list2, nrow = 2, ncol = ceiling(length(plot_list) / 2), labels = toupper(letters[1:5]))
p

ggsave(plot = p, filename = "./figures/beadbeating_experiment_metrics.png", device = "png", height = 13, width = 15)
```

