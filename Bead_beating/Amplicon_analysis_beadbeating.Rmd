---
title: "Analysis of DNA quality as an effect of bead beating settings"
author: "Thomas Bygh Nymann Jensen"
datae: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

# This is code to replicate the analysis used for my HT paper
# The data includes Nanodrop, Qubit, ScreenTape, Extaction and Library concentrations
# as well as amplicon V1-4 data

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE)

# Load the needed packages.
library(patchwork)
library(ampvis2)
library(data.table)
library(tidyverse)
source("loaddata.R")
colors <- c("royalblue4", "seagreen", "salmon")
colors2 <- c("#C6DBEF", "#4292C6", "#08306B")
```

Data removed for RPM = 1000 as results are bad - bead beating does not seem to work at this speed.

# Amplicon analysis

## QC - PCR controls

```{r}
# subset pcr-controls (no kit value)
data_controls <- amp_subset_samples(datraw, Soil_type %in% c("PCR-POS", "PCR-NEG", "Blank"))

# evaluate number of reads
tab_reads <- data_controls$metadata %>%
  mutate(NoReads = colSums(data_controls$abund))

# plot number of reads in the two plates with 
plot_controls_reads <- tab_reads %>%
  ggplot(aes(x = reorder(Sample_id, +NoReads),
             y = NoReads, fill = Sample_id)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 1) +
  #scale_y_continuous(limits = c(0, 5000), 
  #                   breaks = seq(0, 5000, 500)) +
  geom_text(data = tab_reads, aes(label = NoReads), 
            position = position_dodge(width = 1), 
            vjust = -0.5, 
            size = 6) +
  labs(
    title = "Number of reads in PCR controls",
    fill = "Control",
    x = "",
    y = "Obtained reads") +
  #scale_fill_manual(values = c("salmon", "royalblue4", "seagreen", "seagreen", "seagreen", "seagreen")) +
  theme_bw(base_size = 14) +
  theme(axis.text.x = element_text(angle = 90))

# plot heatmap of rarefied reads
plot_PCR_POS <- 
  data_PCR %>% 
  amp_subset_samples(Sample_id == "PCR-POS") %>%
  amp_heatmap(
    facet_by = "Soil_type",
    tax_aggregate = "Phylum",
    tax_show = 9,
    color_vector = c("white", "royalblue4"),
    plot_values = TRUE,
    normalise = T
  ) +
  #scale_fill_gradient(low = "white", high = "royalblue4", limits = c(0, 21), breaks = seq(0, 21, 3)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text.x = element_blank(),
        plot.title = element_text("Heatmap of PCR positives")) + 
  theme_bw()

plot_PCR_NEG <-
  data_PCR %>% 
  amp_subset_samples(Sample_id == "PCR-NEG") %>%
  amp_heatmap(
    facet_by = "Soil_type",
    tax_aggregate = "OTU",
    tax_add = "Phylum",
    tax_show = 15,
    color_vector = c("white", "salmon"),
    plot_values = TRUE,
    normalise = T
  ) +
  #scale_fill_gradient(low = "white", high = "salmon", limits = c(0, 70), breaks = seq(0, 70, 10)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text.x = element_blank(),
        plot.title = element_text("Heatmap of PCR negatives")) +
  theme_bw()

# organize plots
plot_PCR_reads / (plot_PCR_NEG + plot_PCR_POS)


# test which OTU's are present in the negative control above 5 reads
neg_subset <- 
  data_PCR %>% 
  amp_subset_samples(Sample_id == "PCR-NEG")

wh_OTU_PCR_NEG <- 
  {neg_subset$abund > 5} %>%
  apply(1, any) %>% 
  {.[.]} %>%
  names()

# evaluate contamination
data_con <- amp_subset_taxa(ampvis.data, tax_vector = wh_OTU_PCR_NEG)

tab_reads_con <- data_con$metadata %>%
  mutate(NoReads = colSums(data_con$abund))

# plot number of reads in the two plates with 
plot_PCR_reads <- tab_reads %>%
  ggplot(aes(x = reorder(Soil_type, +NoReads),
             y = NoReads, fill = Sample_id)) +
  geom_bar(position = "dodge", stat = "identity", alpha = 1) +
  scale_y_continuous(limits = c(0, 5000), 
                     breaks = seq(0, 5000, 500)) +
  geom_text(data = tab_reads, aes(label = NoReads), 
            position = position_dodge(width = 1), 
            vjust = -0.5, 
            size = 6) +
  labs(
    title = "Number of reads in PCR controls",
    fill = "Control",
    x = "",
    y = "Obtained reads") +
  scale_fill_manual(values = c("salmon", "royalblue4")) +
  theme_bw(base_size = 14)

```
Some contamination seems to be present in the negative control. The contaminations seems to be a result of cross-sample or NFW contamination as 26 OTUs are abundant above 5 reads.

## QC - blanks

```{r}
data_blank <- 
  amp_subset_samples(
    dataraw, 
    Soil_type == "Blank" & RPM != "1000")

tab_reads <- 
  data_blank$metadata %>%
  merge(
    data.frame(
      NoReads = apply(
        data_blank$abund, 2, sum)
      ),
    by = 0
  )

# plot number of reads from blanks
plot_blank_reads <-
  tab_reads %>%
  ggplot(
    aes(
      x = RPM,
      y = NoReads
    )
  ) +
  geom_bar(position = "dodge", stat = "identity", alpha = 1, fill = "grey75") +
  scale_y_continuous(limits = c(0, 2200), 
                     breaks = seq(0, 2200, 200)) +
  geom_text(data = tab_reads, 
            aes(label = NoReads), 
            position = position_dodge(width = 1), 
            vjust = -0.5, 
            size = 6) +
  labs(y = "Obtained reads") +
  ggtitle("Number of reads in PCR controls",
    subtitle = "Samples faceted by bead beating intensity") +
  #scale_fill_manual(
  #  values = c("white", "grey75")) +
  theme_bw(base_size = 14)

# plot heatmap of rarefied reads
plot_blank <- 
  data_blank %>% 
  amp_heatmap(
    facet_by = "RPM",
    tax_aggregate = "Phylum",
    tax_show = 9,
    color_vector = c("white", "grey75"),
    plot_values = TRUE,
    normalise = T
  ) +
  #scale_fill_gradient(low = "white", high = "grey75", limits = c(0, 75), breaks = seq(0, 75, 15)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  ggtitle("Heatmap for blank samples",
    subtitle = "Samples faceted by bead beating intensity"
  ) +
  theme_bw(base_size = 14)

# organize plots
g_blank <- 
  ggarrange(
    plot_blank_reads, 
    plot_blank, 
    ncol = 1)

# save plots as png.
ggsave(
  "Blank_controls.png", 
  plot = g_blank, 
  width = 10, 
  height = 7)
```

Quite a lot of contamination seems to be present in the case of 1200 and 1400 RPM. Most of the OTUs also seem to be present in 1600 and 1800 RPM, but has a much lower read count. 20 OTUs intersect between the contamination in the PCR negatives and the blanks (when n > 5). 

```{r}
# intersecting OTU's
data_blank_sub <- 
  data_blank %>%
  amp_subset_samples(RPM %in% c("1600", "1800"))

wh_OTU_blank <- 
  {
    data_blank_sub$abund > 2
  } %>%
  apply(1, any) %>%
  {
    .[.]
  } %>%
  names()

data_blank_OTU <- 
  data_blank_sub %>%
  amp_subset_taxa(
    tax_vector = wh_OTU_blank)

intersect <- 
  intersect(
    wh_OTU_blank, 
    wh_OTU_PCR_NEG)

data_intersect <- 
  dataraw %>%
  amp_subset_samples(
    !Sample_id %in% c("MFD004-1", "MFD004-3", "MFD004-4", "PCR-POS") & !LibID == "LIB-BLANK-1000-360")

plot_intersect <- 
  data_intersect %>% 
  amp_heatmap(
    facet_by = "LibID",
    tax_aggregate = "OTU",
    tax_add = "Phylum",
    tax_show = 20,
    color_vector = c("white", "grey75"),
    plot_values = TRUE,
    normalise = T
  ) +
  #scale_fill_gradient(low = "white", high = "grey75", limits = c(0, 75), breaks = seq(0, 75, 15)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  ggtitle("Heatmap for contamination",
    subtitle = "Samples faceted by library ID"
  ) +
  theme_bw(base_size = 14)
```


## QC - samples

```{r}
dat_types <- amp_subset_samples(datraw,Soil_type != "Blank" & !is.na(Kit))

tabReads <- merge(
  dat_types$metadata,
  data.frame(NumReads = apply(dat_types$abund, 2, sum)),
  by = 0)

plot.Num_reads <- tabReads %>%
  ggplot(aes(x = Soil_type, y = NumReads, fill = Soil_type)) + 
  facet_grid(RPM ~ Time) +
  geom_boxplot(alpha = 0.5) +
  geom_point(position = position_jitterdodge(jitter.width = .1)) +
  labs(x = "",
       y = "",
       title = "Number of reads across sample types") +
  scale_fill_manual(values = colors) +
  theme_bw(base_size = 10) +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        plot.margin = unit(c(0, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

plot.Num_reads

plot.rarecurve <- dat_types %>%
  amp_rarecurve(facet_by = "RPM", color_by = "Time") + 
  scale_color_manual(values = alpha(colors2, 0.5)) +
  labs(x = "",
       y = "",
       title = "Number of observed ASVs as function of sequencing depth") +
  theme_bw(base_size = 10) +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        plot.margin = unit(c(0, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

plot.rarecurve
```


```{r}
# Create subsets
dat_types_sub4000 <- amp_subset_samples(dat_types, minreads = 4000)
dat_types_sub4000_ra <- amp_subset_samples(dat_types_sub4000, rarefy = min(colSums(dat_types_sub4000$abund)))

phyla.text <- dat_types_sub4000_ra %>%
  amp_heatmap(group_by = c("Project_id"),
              tax_aggregate = "Phylum",
              measure = "median",
              tax_show = 7000,
              normalise = FALSE,
              textmap = TRUE) %>%
  mutate(total = rowSums(.)) %>%
  select(total) %>%
  arrange(desc(total)) %>%
  dplyr::slice(1:20) %>%
  rownames(.)

plot.heat_all <- dat_types_sub4000 %>%
  amp_heatmap(facet_by = c("Soil_type", "RPM"),
              group_by = "Time",
              tax_aggregate = "Phylum",
              tax_show = phyla.text,
              min_abundance = 0.1,
              plot_values = F,
              plot_values_size = 3,
              #order_y_by = order,
              color_vector = c("salmon", "white", "royalblue4")) +
  labs(x = "",
       y = "",
       title = "Heatmap aggregated at phylum level across RPM and time") +
  theme_bw(base_size = 10) +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        plot.margin = unit(c(0, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))
  
plot.ord_all <- dat_types_sub4000_ra %>%
  #amp_subset_samples(Soil_type == "Clay") %>%
  amp_ordinate(filter_species = 0.05, 
               type = "PCoA",
               distmeasure = "bray",
               transform = "none",
               species_plot = FALSE,
               sample_color_by = "Soil_type",
               sample_shape_by = "RPM",
               sample_colorframe = FALSE) +
  scale_color_manual(values = colors, guide = "none") +
  scale_fill_manual(values = colors) +
  labs(title = "PCoA of microbial diversity",
       fill = "Sample type",
       shape = "Intensity [RPM]") +
  ggforce::geom_mark_ellipse(aes(fill = Soil_type, group = Soil_type), alpha = 0.5, color = "black") +
  theme_bw(base_size = 10) +
  theme(legend.position = "right",
        axis.text.x = element_text(face = "bold", vjust = 0.5, size = 10),
        axis.text.y = element_text(face = "bold", size = 10),
        axis.title = element_text(face = "bold", size = 10),
        plot.margin = unit(c(0, 1, 0, 0), "cm"),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        strip.text.x = element_text(size = 7, face = "bold"),
        strip.text.y = element_text(size = 7, face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "bold", size = 10))

plot.ord_all

#The plot with a zoom
plot.insert <- plot.ord_all +
  xlim (0.16, 0.22) +
  ylim (-0.35, -0.28) +
  theme(plot.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")

plot.ordinate.insert <- plot.ord_all + 
  annotation_custom(ggplotGrob(plot.insert), xmin = -0.3, xmax = 0.2, ymin = -0.2, ymax = 0.2) +
  geom_rect(aes(xmin = -0.3, xmax = 0.2, ymin = -0.2, ymax = 0.2), color='black', linetype='dashed', alpha=0) +
  geom_rect(aes(xmin = 0.16, xmax = 0.22, ymin = -0.35, ymax = -0.28), color = "black", alpha = 0) +
    geom_segment(aes(x = 0.16, y = -0.35, xend = -0.3, yend = -0.2), color = "black", linetype = "dashed") +
      geom_segment(aes(x = 0.22, y = -0.28, xend = 0.2, yend = 0.2), color = "black", linetype = "dashed")

plot.ordinate.insert

plot.rda_clay <- dat_types_sub4000_ra %>%
  amp_subset_samples(Soil_type == "Clay") %>%
  amp_ordinate(filter_species = 0.05, 
               type = "RDA",
               constrain = c("RPM", "Time"),
               distmeasure = "bray",
               #sample_trajectory = "Time",
               transform = "none",
               species_plot = FALSE,
               #species_label_taxonomy = "Genus",
               #species_nlabels = 10,
               sample_color_by = "Time",
               sample_shape_by = "RPM",
               sample_colorframe = FALSE) +
  #ggforce::geom_mark_hull(aes(group = RPM), alpha = 0.5, color = "black") +
  ggforce::geom_mark_ellipse(aes(group = RPM), alpha = 0.5, color = "black") +
  scale_color_manual(values = colors2) +
  scale_shape_discrete(guide = "none") +
  labs(title = "RDA constrained by RPM and Time - Clay",
       color = "Time [s]") +
  xlim(-10,10) +
  ylim(-10,10) +
  guides(color = guide_legend(override.aes = list(size = 5, shape = 15))) +
  theme(legend.position = "right",
      axis.text.x = element_text(face = "bold", vjust = 0.5, size = 10),
      axis.text.y = element_text(face = "bold", size = 10),
      axis.title = element_text(face = "bold", size = 10),
      plot.margin = unit(c(0, 1, 1, 0), "cm"),
      plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
      strip.text.x = element_text(size = 7, face = "bold"),
      strip.text.y = element_text(size = 7, face = "bold"),
      legend.title = element_text(face = "bold"),
      legend.text = element_text(face = "bold", size = 10))

plot.rda_clay

plot.rda_organic <- dat_types_sub4000_ra %>%
  amp_subset_samples(Soil_type == "Organic") %>%
  amp_ordinate(filter_species = 0.05, 
               type = "RDA",
               constrain = c("RPM", "Time"),
               distmeasure = "bray",
               #sample_trajectory = "Time",
               transform = "none",
               species_plot = FALSE,
               sample_color_by = "Time",
               sample_shape_by = "RPM",
               sample_colorframe = FALSE) +
  #ggforce::geom_mark_hull(aes(group = RPM), alpha = 0.5, color = "black") +
  ggforce::geom_mark_ellipse(aes(group = RPM), alpha = 0.5, color = "black") +
  scale_color_manual(values = colors2) +
  labs(title = "RDA constrained by RPM and Time - Organic") +
  xlim(-10,10) +
  ylim(-10,10) +
  theme(legend.position = "none",
      axis.text.x = element_text(face = "bold", vjust = 0.5, size = 10),
      axis.text.y = element_text(face = "bold", size = 10),
      axis.title = element_text(face = "bold", size = 10),
      plot.margin = unit(c(0, 1, 1, 0), "cm"),
      plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
      strip.text.x = element_text(size = 7, face = "bold"),
      strip.text.y = element_text(size = 7, face = "bold"),
      legend.title = element_text(face = "bold"),
      legend.text = element_text(face = "bold", size = 10))


plot.rda_sand <- dat_types_sub4000_ra %>%
  amp_subset_samples(Soil_type == "Sand") %>%
  amp_ordinate(filter_species = 0.05, 
               type = "RDA",
               constrain = c("RPM", "Time"),
               distmeasure = "bray",
               #sample_trajectory = "Time",
               transform = "none",
               species_plot = FALSE,
               #species_label_taxonomy = "Phylum",
               #species_nlabels = 10,
               #envfit_factor = "Time",
               sample_color_by = "Time",
               sample_shape_by = "RPM",
               sample_colorframe = FALSE) +
  #ggforce::geom_mark_hull(aes(group = RPM), alpha = 0.5, color = "black") +
  ggforce::geom_mark_ellipse(aes(group = RPM), alpha = 0.5, color = "black") +
  scale_color_manual(values = colors2) +
  labs(title = "RDA constrained by RPM and Time - Sand",
       shape = "Intensity [RPM]") +
  xlim(-10,10) +
  ylim(-10,10) +
  theme(legend.position = "none",
      axis.text.x = element_text(face = "bold", vjust = 0.5, size = 10),
      axis.text.y = element_text(face = "bold", size = 10),
      axis.title = element_text(face = "bold", size = 10),
      plot.margin = unit(c(0, 1, 1, 0), "cm"),
      plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
      strip.text.x = element_text(size = 7, face = "bold"),
      strip.text.y = element_text(size = 7, face = "bold"),
      legend.title = element_text(face = "bold"),
      legend.text = element_text(face = "bold", size = 10))

plot.rda_sand

  

alpha <- dat_types_sub4000_ra %>%
  amp_alpha_diversity(measure = c("observed", "shannon", "simpson"), richness = TRUE) %>%
  select(Time, RPM, Soil_type, ObservedOTUs, Shannon, Simpson, Chao1, ACE) %>%
  group_by(Time, RPM, Soil_type) %>%
  pivot_longer(cols = 4:8, names_to = "index", values_to = "diversity")

plot.alpha_all <- alpha %>%
  filter(index %in% c("Shannon")) %>%
  ggplot(aes(x = RPM, y = diversity, fill = Time)) +
  facet_grid(
    cols = vars(Soil_type),
    scales = "free_y") +
  geom_boxplot(outlier.size = 0, alpha = 0.5) +
  #geom_violin(alpha = 0.5) +
  geom_point(position = position_jitterdodge(jitter.width = 0.1)) +
  labs(
    x = "",
    y = "",
    fill = "Time [s]",
    color = "Time [S]") +
  scale_fill_manual(values = colors2) +
  theme_bw(base_size = 10) +
  labs(title = "Shannon diversity index across intensity and time") +
  guides(color = guide_legend(override.aes = list(size = 1))) +
  theme(legend.position = "none",
      axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
      axis.text.y = element_text(face = "bold", size = 10),
      axis.title = element_text(face = "bold", size = 10),
      plot.margin = unit(c(0, 1, 0, 0), "cm"),
      plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
      strip.text.x = element_text(size = 7, face = "bold"),
      strip.text.y = element_text(size = 7, face = "bold"),
      legend.title = element_text(face = "bold"),
      legend.text = element_text(face = "bold", size = 10))

(plot.heat_all / (plot.ord_all + plot.alpha_all)) | plot.rda_clay / plot.rda_organic / plot.rda_sand
  
```

# Plotting
```{r}
#Figur 1
design <- "
  224
  224
  225
  315
  316
  316
"

plot.ordinate.insert + plot.heat_all + plot.alpha_all + plot.rda_clay + plot.rda_organic + plot.rda_sand + plot_layout(design = design, guides = "collect")
  #theme(legend.position = "right")

ggsave("beadbeating1.png", width = 15.36, height = 8.14, dpi = 600)
```

