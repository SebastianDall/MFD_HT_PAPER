---
title: "Amplicon diversity of MFD standard samples 2.0"
author: "Thomas Bygh Nymann Jensen, Thomas Y. Michaelsen"
date: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)

library(here)
setwd(here("Benchmarking"))

# Load the needed packages.
library(data.table)
library(readxl)
library(tidyverse)
library(ampvis2)
# library(DESeq2)
library(vegan)
library(patchwork)
library(ggpubr)

### Load and tidy ###
source("loaddata.R")
source(here("Benchmarking", "functions.R"))
colors <- c("grey", "darkgoldenrod2", "royalblue4", "seagreen", "salmon", "purple")


# Load theme
source("../article_theme.R")
```

## filter data
```{r}
dat_types <- datraw %>%
  amp_subset_samples(!Soil_type %in% c("Blank", "Activated sludge") & !is.na(Kit))
```

## $\alpha$-diversity

```{r}
# Create subsets
dat_types_sub10000 <- amp_subset_samples(dat_types, minreads = 10000)
dat_types_sub10000_ra <- amp_subset_samples(dat_types_sub10000, rarefy = min(colSums(dat_types_sub10000$abund)))
```

We set a cutoff of at 10000 reads, and rarefy to the lowest number of reads in the remaining dataset. Doing this we go from `r nrow(dat_types$metadata)` to `r nrow(dat_types_sub10000_ra$metadata)` samples and create a rarified dataset as well.

We asses $\alpha$-diversity after rarefying the reads pr sample. We look at the Shannon-index and number of ASVs.


```{r}
missingMIDAS <- tibble(Soil_type = c("Organic", "Sand-Clay"), Kit = "MIDAS HT", failed_lib = 3)

numberOfReads <- merge(
  dat_types$metadata,
  data.frame(NumReads = apply(dat_types$abund, 2, sum)),
  by = 0
) %>%
  select(SeqID, Soil_type, Kit, NumReads) %>%
  filter(NumReads > 10000)


alpha_div_subs10000_ra <- dat_types_sub10000_ra %>%
  amp_alphadiv(
    measure = c("observed", "shannon", "simpson"),
    richness = T
  ) %>%
  select(
    SeqID,
    Soil_type,
    Kit,
    ObservedOTUs,
    Shannon
  )

alpha_div_subs10000_ra_summarise <- alpha_div_subs10000_ra %>%
  left_join(numberOfReads) %>%
  group_by(Soil_type, Kit) %>%
  mutate(failed_lib = 3 - n()) %>%
  summarise(
    meanReads = round(mean(NumReads)),
    # sdReads = sd(NumReads),
    meanOTU = round(mean(ObservedOTUs), 0),
    sdOTU = sd(ObservedOTUs),
    mean_shannon = mean(Shannon),
    sdShannon = sd(Shannon),
    failed_lib = max(failed_lib)
  ) %>%
  ungroup() %>%
  mutate(across(where(is.numeric), ~ round(., 2))) %>%
  bind_rows(missingMIDAS) %>%
  arrange(Soil_type, Kit)

whereNA <- alpha_div_subs10000_ra_summarise %>%
  mutate(rownumber = row_number() + 1) %>%
  filter(if_any(where(is.numeric), is.na) | failed_lib > 0) %>%
  pivot_longer(-c(Soil_type, Kit, rownumber), names_to = "variable", values_to = "value")


hjustification_matrix <- as.vector(matrix(c(0, 0, 1, 1, 1, 1, 1, 1), ncol = 8, nrow = nrow(alpha_div_subs10000_ra_summarise), byrow = TRUE))
xjustification_matrix <- as.vector(matrix(c(0.1, 0.1, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9), ncol = 8, nrow = nrow(alpha_div_subs10000_ra_summarise), byrow = TRUE))


alpha_table <- alpha_div_subs10000_ra_summarise %>%
  mutate(Soil_type = if_else(Kit != "FastSpin", "", Soil_type)) %>%
  relocate(failed_lib, .after = Kit) %>%
  rename(`Soil Type` = Soil_type, `Mean\nASVs` = meanOTU, `Sd\nASVs` = sdOTU, `Mean\nShannon` = mean_shannon, `Sd\nShannon` = sdShannon, `Failed\nLibraries` = failed_lib, `Mean\nReads` = meanReads) %>%
  ggtexttable(rows = NULL, theme = ttheme(colnames.style = colnames_style(fill = "white"), tbody.style = tbody_style(fill = "white", hjust = hjustification_matrix, x = xjustification_matrix))) %>%
  tab_add_hline(at.row = 1:2, row.side = "top", linewidth = 2) %>%
  tab_add_hline(at.row = seq(8, 26, 6), row.side = "top", linewidth = 1) %>%
  addTableColor(df = whereNA, filter_col = "meanReads", column = 4) %>%
  addTableColor(df = whereNA, filter_col = "meanOTU", column = 5) %>%
  addTableColor(df = whereNA, filter_col = "sdOTU", column = 6) %>%
  addTableColor(df = whereNA, filter_col = "mean_shannon", column = 7) %>%
  addTableColor(df = whereNA, filter_col = "sdShannon", column = 8) %>%
  table_cell_font(row = filter(whereNA, variable == "failed_lib", value > 0)$rownumber, column = 3, face = "bold", color = "black") %>%
  tab_add_title(text = "Table 1: Sequencing Stats and Microbial Alpha diversity")

# alpha_table
```

```{r}
# div_multicomp <- amp_alphadiv(dat_types_sub10000_ra,
#   measure  = c("observed", "shannon", "simpson"),
#   richness = T
# ) %>%
#   select(SeqID, Kit, Soil_type, ObservedOTUs, Shannon, Simpson, Chao1, ACE) %>%
#   pivot_longer(cols = c(ObservedOTUs, Shannon, Simpson, Chao1, ACE), names_to = "index", values_to = "diversity")

# plot.alpha <- div_multicomp %>%
#   filter(index %in% c("Shannon")) %>%
#   ggplot(aes(x = Kit, y = diversity, fill = Soil_type)) +
#   facet_grid(cols = vars(Soil_type)) +
#   # geom_violin(alpha = 0.5) +
#   geom_boxplot(outlier.size = 0, alpha = 0.5) +
#   geom_point(position = position_jitterdodge(jitter.width = .1)) +
#   labs(x = "", y = "", title = "Shannon diversity index across samples") +
#   scale_fill_manual(values = colors) +
#   theme_bw(base_size = 10) +
#   theme(
#     legend.position = "none",
#     axis.text.x = element_text(angle = 90, face = "bold", vjust = 0.5, size = 10),
#     axis.text.y = element_text(face = "bold", size = 10),
#     axis.title = element_text(face = "bold", size = 10),
#     plot.margin = unit(c(1, 1, 0, 0), "cm"),
#     plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
#     strip.text.x = element_text(size = 7, face = "bold"),
#     strip.text.y = element_text(size = 7, face = "bold"),
#     legend.title = element_text(face = "bold"),
#     legend.text = element_text(face = "bold", size = 10)
#   )

# plot.alpha
```

Lets try to quantify how much the kit and soil_type contributes to explaining the variance in diversity. For that we construct a linear model and run ANOVA on it. For `Shannon`:
```{r}
tmp <- filter(div_multicomp, index %in% "Shannon")

anova.shannon <- anova(lm(diversity ~ Kit * Soil_type, data = tmp)) %>%
  data.frame() %>%
  rownames_to_column("Variable") %>%
  mutate(R2 = Sum.Sq / sum(Sum.Sq) * 100) %>%
  mutate(across(R2, ~ round(., digits = 2))) %>%
  mutate(pval = ifelse(Pr..F. < 0.001, "<0.001", round(Pr..F., 2))) %>%
  select(Variable, R2, pval) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)
```


## $\beta$-diversity

### Ordination
```{r}
plot.ordinate <- plotAmpliconOrdination(dat_types_sub10000_ra, rel_ab_filter = 0.1) +
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  theme(legend.position = "bottom")


plot.ordinate

plot.xlim <- c(-0.45, -0.375)
plot.ylim <- c(-2.05, -1.8)
# The plot with a zoom
plot.insert <- plot.ordinate +
  ylim(plot.ylim) +
  xlim(plot.xlim) +
  theme(
    plot.title = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "none"
  )


plot.insert.x <- 0
plot.insert.xmax <- 1.4
plot.insert.y <- -2
plot.insert.ymax <- 0



plot.ordinate.insert <- plot.ordinate +
  # add plot
  annotation_custom(ggplotGrob(plot.insert), xmin = plot.insert.x, xmax = plot.insert.xmax, ymin = plot.insert.y, ymax = plot.insert.ymax) +
  # Add rect around plot
  geom_rect(aes(xmin = plot.insert.x - 0.05, xmax = plot.insert.xmax - 0.05, ymin = plot.insert.y - 0.05, ymax = plot.insert.ymax + 0.05), color = "black", linetype = "dashed", alpha = 0) +
  # Add rect around data
  geom_rect(aes(xmin = plot.xlim[1], xmax = plot.xlim[2], ymin = plot.ylim[1], ymax = plot.ylim[2]), color = "black", alpha = 0) +
  geom_segment(aes(x = plot.xlim[2], y = plot.ylim[1], xend = plot.insert.x - 0.05, yend = plot.insert.y - 0.05), color = "black", linetype = "dashed") +
  geom_segment(aes(x = plot.xlim[2], y = plot.ylim[2], xend = plot.insert.x - 0.05, yend = plot.insert.ymax + 0.05), color = "black", linetype = "dashed")

plot.ordinate.insert
```

```{r}
# plot.ordinate <- dat_types_sub10000_ra %>%
#   plotAmpliconOrdinationSoil(rel_ab_filter = 0.1, soil_filter = "Clay") +
#   scale_color_manual(values = colors) +
#   scale_fill_manual(values = colors) +
#   theme(legend.position = "bottom")
soil <- unique(dat_types_sub10000_ra$metadata$Soil_type)
ord_type <- "CA"

for (s in soil) {
  p <- plotAmpliconOrdinationSoil(dat_types_sub10000_ra, s, ord_type = ord_type)
  ggsave(here("Benchmarking", "figures", paste0("ordination_", ord_type, "_rel_ab_0.1_rarefied_", s, ".png")), plot = p, height = 7, width = 9, device = "png")
}
```


#### Permanova ordination
```{r}
otu <- dat_types_sub10000_ra$abund %>% t()

permanova1 <- adonis2(otu ~ Kit, data = dat_types_sub10000_ra$metadata, permutations = 999, method = "bray", by = "terms")

permanova1 %>%
  rownames_to_column("Variable") %>%
  mutate(across(3:6, ~ round(., digits = 3))) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)

# permanova2 <- adonis2(otu ~ Soil_type, data = dat_types_sub10000_ra$metadata, permutations = 999, method = "bray", by = "terms")

# permanova2 %>%
#   rownames_to_column("Variable") %>%
#   mutate(across(3:6, ~round(., digits = 3))) %>%
#   gridExtra::tableGrob(rows = NULL) %>%
#   gridExtra::grid.arrange(.)

# dist <- vegdist(otu)
# anova(betadisper(dist, dat_types_sub10000_ra$metadata$Kit))
```

# Plotting
```{r}
dummy_table <- ggarrange(alpha_table, NULL, nrow = 2, heights = c(1, 0.035))

p <- ggarrange(dummy_table, NULL, plot.ordinate.insert, ncol = 3, common.legend = T, legend = "bottom", widths = c(1, 0.05, 1), labels = c("A", "B"))

ggsave(here("Benchmarking", "figures", "ordination_CA_table_v2.png"), device = "png", height = 11, width = 15, plot = p)
```



# Below is old figures

```{r}
# Figur 1
design <- "
  15
  15
  35
  34
  34
"

plot.failed_libs + plot.rarecurve + plot.alpha + plot.ordinate.insert + plot_layout(design = design, guides = "collect") +
  # labs(fill = "Sample type",
  #     shape = "Extraction Kit") +
  theme(legend.position = "right")

ggsave("benchmarking1.png", width = 15.36, height = 8.14, dpi = 600)
```




## Gram positive bias

### Heatmap
```{r}
phyla.text <- dat_types_sub10000_ra %>%
  amp_heatmap(
    group_by = c("Kit"),
    tax_aggregate = "Phylum",
    measure = "median",
    tax_show = 7000,
    normalise = FALSE,
    textmap = TRUE
  ) %>%
  mutate(total = rowSums(.)) %>%
  select(total) %>%
  arrange(desc(total)) %>%
  dplyr::slice(1:20) %>%
  rownames(.)

heatmap <- dat_types_sub10000 %>%
  amp_heatmap(
    facet_by = "Soil_type",
    group_by = "Kit",
    tax_aggregate = "Phylum",
    # tax_add = c("Phylum"),
    tax_show = phyla.text,
    plot_values = FALSE,
    color_vector = c("salmon", "white", "royalblue4")
  ) +
  labs(
    x = "",
    y = "",
    title = "Heatmap aggregated at the phylum level across kits and sample types"
  ) +
  articletheme +
  theme(
    strip.text.x = element_text(size = 12),
    plot.title = element_text(size = 14)
  )
```
```{r}
ggsave(here("Benchmarking", "figures", "heatmap.png"), plot = heatmap, device = "png", height = 8, width = 12)
```

```{r}
# POwerSoil Pro HT vs ZymoMagbead HT
dat_types_sub10000_ra_Gram_pos1 <- dat_types_sub10000_ra %>%
  amp_subset_samples(Kit %in% c("ZymoMagbead HT", "PowerSoil Pro HT"))

res <- ampvis2extras::amp_diffabund(dat_types_sub10000_ra_Gram_pos1, group = "Kit", tax_aggregate = "Phylum")

plot.sig1 <- res$signif_plotdata %>%
  dplyr::rename(SeqID = Sample) %>%
  merge(meta %>% select(-Kit), by = "SeqID") %>%
  mutate(across(Kit, ~ str_replace_all(., "_", " "))) %>%
  ggplot(aes(x = Kit, y = Abundance, fill = Soil_type)) +
  facet_wrap(facets = vars(Tax), nrow = 1) +
  geom_boxplot(alpha = 0.5) +
  geom_point(position = position_jitterdodge(jitter.width = .1)) +
  labs(
    x = "",
    y = "Read Abundance (%)",
    title = "Differential abundance across sample types"
  ) +
  scale_fill_manual(values = colors) +
  theme_bw(base_size = 10) +
  theme(
    axis.text.x = element_text(angle = 90, face = "bold", size = 10, vjust = 0.5),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
    axis.text.y = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    # axis.ticks.x = element_blank(),
    legend.position = "right",
    plot.margin = unit(c(1, 1, 0, 0), "cm"),
    strip.text.x = element_text(size = 7, face = "bold"),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(face = "bold", size = 10)
  )

plot.sig1

plot.ma1 <- res$plot_MA$data %>%
  ggplot(aes(x = baseMean, y = log2FoldChange, fill = Significant)) +
  geom_point(size = 4, alpha = 0.5, shape = 21) +
  ggrepel::geom_label_repel(aes(label = Tax),
    data = res$plot_MA$data %>% filter(Significant == "Significant"),
    color = "black", fill = NA, box.padding = 1,
    max.overlaps = 10
  ) +
  geom_label(aes(x = 250, y = -3.5, label = "PowerSoil Pro HT"), inherit.aes = FALSE, size = 4, label.size = 0) +
  geom_label(aes(x = 250, y = 3.5, label = "ZymoMagbead HT"), inherit.aes = FALSE, size = 4, label.size = 0) +
  labs(colour = "P-adj < 0.01") +
  scale_fill_manual(values = c("grey", "salmon")) +
  theme_bw(base_size = 10) +
  scale_x_log10() +
  labs(
    y = "Log2 fold change",
    x = "BaseMean Read Abundance",
    title = "MA plot with significant different phyla highlighted"
  ) +
  theme(
    axis.text.x = element_text(angle = 90, face = "bold", size = 10, vjust = 0.5),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
    axis.text.y = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    # axis.ticks.x = element_blank(),
    legend.position = "right",
    plot.margin = unit(c(1, 1, 0, 0), "cm"),
    strip.text.x = element_text(size = 7, face = "bold"),
    legend.title = element_text(face = "bold"),
    legend.text = element_text(face = "bold", size = 10)
  )

plot.ma1

# PowerSoil Pro HT vs. FastSpin HT
dat_types_sub10000_ra_Gram_pos2 <- dat_types_sub10000_ra %>%
  amp_subset_samples(Kit %in% c("FastSpin HT", "PowerSoil Pro HT"))

res2 <- ampvis2extras::amp_diffabund(dat_types_sub10000_ra_Gram_pos2, group = "Kit", tax_aggregate = "Phylum")

plot.sig2 <- res2$signif_plotdata %>%
  dplyr::rename(SeqID = Sample) %>%
  merge(meta %>% select(-Kit), by = "SeqID") %>%
  ggplot(aes(x = Kit, y = Abundance, fill = Soil_type)) +
  geom_boxplot(aes(group = Kit), alpha = 0.5) +
  facet_grid(rows = vars(Soil_type), scales = "free") +
  geom_point(position = position_jitterdodge(jitter.width = .1)) +
  coord_flip() +
  scale_fill_manual(values = colors) +
  theme_bw()

plot.sig2

plot.ma2 <- res2$plot_MA$data %>%
  ggplot(aes(x = baseMean, y = log2FoldChange, fill = Significant)) +
  geom_point(size = 4, alpha = 0.5, shape = 21) +
  ggrepel::geom_label_repel(aes(label = Tax),
    data = res2$plot_MA$data %>% filter(Significant == "Significant"),
    color = "black", fill = NA, box.padding = 1,
    max.overlaps = 10
  ) +
  geom_label(aes(x = 250, y = -3.5, label = "PowerSoil Pro HT"), inherit.aes = FALSE, size = 6, label.size = 0) +
  geom_label(aes(x = 250, y = 3.5, label = "FastSpin HT"), inherit.aes = FALSE, size = 6, label.size = 0) +
  labs(colour = "P-adj < 0.01") +
  scale_fill_manual(values = c("grey", "salmon")) +
  theme_bw() +
  scale_x_log10()

plot.ma2


# ZymoMagbead HT vs. FastSpin HT
dat_types_sub10000_ra_Gram_pos3 <- dat_types_sub10000_ra %>%
  amp_subset_samples(Kit %in% c("FastSpin HT", "ZymoMagbead HT"))

res3 <- ampvis2extras::amp_diffabund(dat_types_sub10000_ra_Gram_pos3, group = "Kit", tax_aggregate = "Phylum")

plot.sig3 <- res3$signif_plotdata %>%
  dplyr::rename(SeqID = Sample) %>%
  merge(meta %>% select(-Kit), by = "SeqID") %>%
  ggplot(aes(x = Kit, y = Abundance, fill = Soil_type)) +
  geom_boxplot(aes(group = Kit), alpha = 0.5) +
  facet_grid(rows = vars(Soil_type), scales = "free") +
  geom_point(position = position_jitterdodge(jitter.width = .1)) +
  coord_flip() +
  scale_fill_manual(values = colors) +
  theme_bw()

plot.sig3

plot.ma3 <- res3$plot_MA$data %>%
  ggplot(aes(x = baseMean, y = log2FoldChange, fill = Significant)) +
  geom_point(size = 4, alpha = 0.5, shape = 21) +
  ggrepel::geom_label_repel(aes(label = Tax),
    data = res3$plot_MA$data %>% filter(Significant == "Significant"),
    color = "black", fill = NA, box.padding = 1,
    max.overlaps = 10
  ) +
  geom_label(aes(x = 250, y = -3.5, label = "FastSpin HT"), inherit.aes = FALSE, size = 6, label.size = 0) +
  geom_label(aes(x = 250, y = 3.5, label = "ZymoMagbead HT"), inherit.aes = FALSE, size = 6, label.size = 0) +
  labs(colour = "P-adj < 0.01") +
  scale_fill_manual(values = c("grey", "salmon")) +
  theme_bw() +
  scale_x_log10()

plot.ma3
```


# Plotting
```{r}
# Figur 1
design <- "
  112
  334
"

p.h1 + p.h2 + plot.ma1 + plot.sig1 + plot_layout(design = design, guides = "collect") +
  # labs(fill = "Sample type",
  #     color = "Significans") +
  theme(legend.position = "right")

ggsave("benchmarking2.png", width = 15.36, height = 8.14, dpi = 600)
```



## Is there an overall batch effect?

```{r}
# Extract relevant metadata.
meta <- dat_types_sub10000_ra$metadata %>%
  select(SeqID, Kit, Soil_type) %>%
  filter(Kit %in% c("PowerSoil Pro HT", "ZymoMagbead HT"))

# Extract matrix summarized to phylum.
phylum <- amp_export_long(dat_types_sub10000_ra_Gram_pos, metadata_vars = c("Kit", "Soil_type"), tax_levels = "Phylum") %>%
  .[, .(count = sum(count)), by = .(SeqID, Phylum, Kit, Soil_type)] %>%
  .[, pct := count / sum(count), by = SeqID] %>%
  .[Phylum != ""] %>%
  mutate(across(Kit:Soil_type, ~ as.factor(.)))

phylum_count <- dcast(phylum, Phylum ~ SeqID, value.var = "count") %>%
  select(Phylum, one_of(meta$SeqID))

phylum_pct <- dcast(phylum, Phylum ~ SeqID, value.var = "pct") %>%
  select(Phylum, one_of(meta$SeqID))

de_phylum <- DESeqDataSetFromMatrix(
  countData = phylum_count,
  colData   = meta,
  tidy      = T,
  design    = ~ Kit * Soil_type
)




de <- DESeq(de_phylum, fitType = "local", test = "LRT", reduced = ~Soil_type)

res <- results(de) %>%
  as.data.frame() %>%
  mutate(Phylum = phylum_count$Phylum) %>%
  filter(!is.na(padj)) %>%
  mutate(log10padj = -log10(padj)) %>%
  mutate(signf = ifelse(padj < 0.01, "Yes", "No"))

ggplot(res, aes(x = baseMean, y = padj, colour = signf)) +
  geom_point() +
  labs(colour = "P-adj < 0.01") +
  theme(legend.position = c(1, 0.5), legend.justification = c(1, 0.5))

# Print the differentially abundant phyla.
res_diff <- filter(res, signf == "Yes") %>% select(Phylum, baseMean, padj)
res_diff
```

Visualize the differntially abundant phyla.

```{r}
ggplot(
  filter(phylum, Phylum %in% res_diff$Phylum),
  aes(x = Kit, y = pct)
) +
  facet_grid(rows = vars(Phylum), cols = vars(Soil_type), scales = "free_y") +
  geom_jitter(width = .1)

ggplot(data = res) +
  geom_point(
    aes(x = baseMean, y = log2FoldChange),
    size = 1.25,
    color = ifelse(res$padj < 0.01, "red", "grey20"),
    alpha = 0.5,
    shape = ifelse(abs(res$log2FoldChange) >= 7.5, 17, 16)
  ) +
  scale_x_log10()
```

## Is the batch-effect different between `Soil_type`?

Visualize the differential abundant phyla.


# Other
```{r}

tmp <- amp_export_long(dat_types_sub10000_ra, metadata_vars = c("Kit", "Soil_type")) %>%
  .[, count := as.numeric(count > 0)] %>%
  .[, keep := uniqueN(SeqID) > 1, by = .(Kit, Soil_type)] %>%
  .[(keep)] %>%
  .[, keep := NULL]

# Calculate average bray-curtis distance within replicates.
tmp2 <- tmp[, .(AvgDist = {
  data.table(x = OTU, y = SeqID, z = count) %>%
    dcast(x ~ y, value.var = "z") %>%
    column_to_rownames("x") %>%
    t() %>%
    vegdist(method = "bray") %>%
    as.vector() %>%
    mean()
}), by = .(Kit, Soil_type)]

ggplot(tmp2, aes(
  x      = Kit,
  y      = AvgDist
)) +
  geom_violin() +
  geom_point(aes(
    color = Soil_type
  )) +
  labs(x = "", y = "Average distance within replicates") +
  scale_color_manual(values = colors) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```




