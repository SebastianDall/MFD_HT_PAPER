---
title: "Amplicon diversity of MFD standard samples 2.0"
author: "Thomas Bygh Nymann Jensen, Thomas Y. Michaelsen"
date: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
output: 
  bookdown::html_document2:
    toc: true
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)

library(here)
setwd(here("Benchmarking"))

# Load the needed packages.
library(data.table)
library(readxl)
library(writexl)
library(tidyverse)
library(ampvis2)
library(DESeq2)
library(vegan)
# library(patchwork)
library(ggpubr)
library(ggrepel)

### Load and tidy ###
source("loaddata.R")
source(here("Benchmarking", "functions.R"))
colors <- c("grey", "darkgoldenrod2", "royalblue4", "seagreen", "salmon", "purple")
kit_colors <- brewer.pal(5, "Dark2")

# Load theme
source("../article_theme.R")
```

## filter data
> Sample MG200131-87 is a clear outlier in PCA space. Therefore it is removed.

```{r}
dat_types <- datraw %>%
  amp_subset_samples(!Soil_type %in% c("Blank", "Activated sludge") & !is.na(Kit) & Kit != "MIDAS HT" & SeqID != "MQ200131-87")
```



```{r}
# Create subsets
dat_types_sub10000 <- amp_subset_samples(dat_types, minreads = 10000)
dat_types_sub10000_ra <- amp_subset_samples(dat_types_sub10000, rarefy = min(colSums(dat_types_sub10000$abund)))
dat_types_sub10000_ra_rel_0.1 <- filter_otus(dat_types_sub10000_ra, 0.1)
```


## $\alpha$-diversity

We set a cutoff of at 10000 reads, and rarefy to the lowest number of reads in the remaining dataset. Doing this we go from `r nrow(dat_types$metadata)` to `r nrow(dat_types_sub10000_ra$metadata)` samples and create a rarified dataset as well.

We asses $\alpha$-diversity after rarefying the reads pr sample. We look at the Shannon-index and number of ASVs.

## Big summary statistics table

>MIDAS was removed at this stage.

```{r}
tax_data_rel_0.1 <- dat_types_sub10000_ra_rel_0.1$abund %>%
  t()

bray_distance <- as.matrix(vegdist(tax_data_rel_0.1)) %>%
  as.data.frame() %>%
  rownames_to_column("SeqID")

metadata <- dat_types_sub10000_ra$metadata %>%
  select(SeqID, Sample_id, Kit, Soil_type)

metadata_renamed <- metadata %>%
  dplyr::rename(
    comparison = SeqID,
    compared_soil = Soil_type,
    compared_kit = Kit
  )

bray_with_metadata <- metadata %>%
  left_join(bray_distance) %>%
  pivot_longer(!SeqID:Soil_type, names_to = "comparison", "value") %>%
  left_join(metadata_renamed)

bray_with_metadata_comparisons <- bray_with_metadata %>%
  filter(SeqID != comparison) %>%
  filter(paste0(Kit, Soil_type) == paste0(compared_kit, compared_soil)) %>%
  filter(!duplicated(paste0(pmax(SeqID, comparison), pmin(SeqID, comparison)))) %>%
  group_by(Soil_type, Kit) %>%
  summarise(
    mean_bray = format(round(mean(value, na.rm = TRUE), 2), nsmall = 2),
    sd_bray = format(round(sd(value, na.rm = TRUE), 2), nsmall = 2)
  )
```

```{r}
lab_metadata <- amplicon_metadata %>%
  select(Sample_id, Plate, Kit, Soil_type, Conc_quibit, `260/280`, `260/230`, PCR2) %>%
  filter(Kit != "MIDAS HT", !Soil_type %in% c("Blank", "Activated sludge")) %>%
  dplyr::rename(Elution_placement = Plate, lib_conc = PCR2, Conc_qubit = Conc_quibit) %>%
  mutate(yield_ng = if_else(Kit == "PowerSoil Pro HT", Conc_qubit * 120, Conc_qubit * 60))

soil_properties_filtered <- soil_properties %>%
  filter(!is.na(Soil_properties)) %>%
  select(Soil_type, Soil_properties)

rarefied_alphadiveristy <- dat_types_sub10000_ra_rel_0.1 %>%
  amp_alphadiv(
    measure = c("observed", "shannon", "simpson"),
    richness = T
  ) %>%
  select(
    SeqID,
    Sample_id,
    Elution_placement,
    Soil_type,
    Kit,
    # ObservedOTUs,
    Shannon
  )

# Join different data: Lab, Alpha, beta.
combine_alpha_beta_with_metadata <- rarefied_alphadiveristy %>%
  right_join(lab_metadata) %>%
  # Calculate failed libraries - FastSpin for sand worked however one sample was an outlier
  group_by(Soil_type, Kit) %>%
  mutate(libs = sum(!is.na(Shannon))) %>%
  # Calculate mean and sd for all variables
  summarise(
    across(where(is.numeric), .fns = list(mean = ~ mean(., na.rm = T), sd = ~ sd(., na.rm = T)), .names = "{.fn}_{.col}")
  ) %>%
  # Format mean and sd
  ungroup() %>%
  mutate(
    libs = as.character(mean_libs),
    across(where(is.numeric), ~ format(round(., 2), nsmall = 2)),
    mean_yield_ng = format(round(as.numeric(mean_yield_ng))),
    sd_yield_ng = format(round(as.numeric(sd_yield_ng)))
  ) %>%
  # Add bray variation
  left_join(bray_with_metadata_comparisons) %>%
  # factor Kit
  mutate(Kit = factor(Kit, levels = kit_levels, labels = kit_levels)) %>%
  arrange(Soil_type, Kit)

mean_sd_table_long <- combine_alpha_beta_with_metadata %>%
  select(-c(sd_libs, mean_libs)) %>%
  pivot_longer(cols = -c(Soil_type, Kit, libs, contains("sd")), names_to = "mean", values_to = "mean_value", names_prefix = "mean_") %>%
  pivot_longer(cols = -c(Soil_type, Kit, libs, contains("mean")), names_to = "sd", values_to = "sd_value", names_prefix = "sd_") %>%
  group_by(Soil_type, Kit) %>%
  filter(mean == sd) %>%
  mutate(
    mean_sd = paste0(mean_value, " (", sd_value, ")")
  ) %>%
  select(!mean_value:sd_value)


mean_sd_table_wide <- mean_sd_table_long %>%
  pivot_wider(names_from = mean, values_from = mean_sd) %>%
  left_join(soil_properties_filtered) %>%
  relocate(Soil_properties, .after = Soil_type) %>%
  relocate(Conc_qubit:`260/230`, .after = Kit) %>%
  relocate(yield_ng, .after = Conc_qubit) %>%
  relocate(lib_conc, .after = libs) %>%
  group_by(Soil_type) %>%
  mutate_at(vars(Soil_type, Soil_properties), ~ replace(., duplicated(.), ""))


names <- tibble(
  old_names = colnames(mean_sd_table_wide),
  new_names = c("Soil type", "Properties", "Kit", "DNA ext conc. [ng/µL]", "DNA yield [ng]", "260/280", "260/230", "Libraries", "Library conc. [ng/µL]", "Shannon Diversity", "Bray-Curtis Variation") # "Site name", "Longitude Latitude", "Environment",
)

final_table <- mean_sd_table_wide %>%
  rename_at(vars(names$old_names), ~ names$new_names)
```
```{r}
writexl::write_xlsx(final_table, path = "./files/benchmark_overview_table.xlsx")
```



Lets try to quantify how much the kit and soil_type contributes to explaining the variance in diversity. For that we construct a linear model and run ANOVA on it. For `Shannon`:
```{r}
tmp <- filter(div_multicomp, index %in% "Shannon")

anova.shannon <- anova(lm(diversity ~ Kit * Soil_type, data = tmp)) %>%
  data.frame() %>%
  rownames_to_column("Variable") %>%
  mutate(R2 = Sum.Sq / sum(Sum.Sq) * 100) %>%
  mutate(across(R2, ~ round(., digits = 2))) %>%
  mutate(pval = ifelse(Pr..F. < 0.001, "<0.001", round(Pr..F., 2))) %>%
  select(Variable, R2, pval) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)
```


## $\beta$-diversity


# Soil ordination panel
```{r}
otu <- dat_types_sub10000_ra$abund
metadata <- dat_types_sub10000_ra$metadata
tax <- dat_types_sub10000_ra$tax

phylum <- tax %>%
  select(Phylum, OTU) %>%
  filter(!is.na(Phylum))

otu_phylum <- otu %>%
  rownames_to_column("OTU") %>%
  right_join(phylum) %>%
  relocate(Phylum, .after = OTU)

total_asvs <- sum(otu_phylum$`MQ200131-1`)

phylum_variable <- otu_phylum %>%
  group_by(Phylum) %>%
  summarise(
    across(where(is.numeric), sum) / total_asvs
  ) %>%
  filter(Phylum != "")

t_phylum_variable <- phylum_variable %>%
  pivot_longer(-Phylum, names_to = "SeqID", values_to = "value") %>%
  pivot_wider(SeqID, names_from = "Phylum", values_from = "value")

metadata_with_phylum <- left_join(metadata, t_phylum_variable)

dat_types_sub10000_ra_with_phylumMetdata <- amp_load(
  metadata = metadata_with_phylum,
  otutable = otu,
  taxonomy = tax
)

phylum_vector <- grep("_{2}", colnames(dat_types_sub10000_ra_with_phylumMetdata$metadata), value = TRUE)
```


```{r}
ordinate_soil_data <- function(soil) {
  generateAmpliconOrdinationData(dat_types_sub10000_ra_with_phylumMetdata, soil, ord_type = "PCA", envvector = phylum_vector)
}
```

```{r}
soil <- unique(dat_types_sub10000_ra$metadata$Soil_type)
gg_kit_colors <- scale_color_manual(values = kit_colors)
gg_kit_fill <- scale_fill_manual(values = kit_colors)

# Use ampvis to generate ordination data
ordinate_data <- tibble(soil = soil) %>%
  mutate(ordination = map(.x = soil, ordinate_soil_data))

# Plot ordination data with new ggplot parameters
ordination_plots <- ordinate_data %>%
  # extract ordination data
  mutate(
    metadata = map(ordination, ~ .x$dsites),
    species = map(ordination, ~ .x$dspecies),
    envfit = map(ordination, ~ .x$evf_numeric_model),
    screeplotdata = map(ordination, ~ .x$screeplot$data)
  ) %>%
  # Factor kit
  mutate(
    metadata = map(.x = metadata, ~ mutate(.x, Kit = factor(Kit, levels = kit_levels)))
  ) %>%
  # create ggplots
  mutate(
    ggmeta = map(.x = metadata, ~ plotMetadataOrdination(.x)),
    ggspecies = map2(.x = ggmeta, .y = species, ~ addSpeciesPlot(.x, .y)),
    ggenv = map2(.x = ggspecies, .y = envfit, ~ addEnvVector(.x, .y)),
    ggaestetics = map2(
      .x = ggenv, .y = soil,
      ~ .x + articlethemex0 + gg_kit_colors + gg_kit_fill + labs(title = paste0(.y)) + theme(legend.position = "none")
    ),
    ggfinal = map2(.x = ggaestetics, .y = screeplotdata, ~ .x + labs(
      x = paste0(.y[1, 1], " [", round(.y[1, 2], 1), "%]"),
      y = paste0(.y[2, 1], " [", round(.y[2, 2], 1), "%]")
    ))
  )


plot_list_with_legend <- addLegendPlot(ordination_plots$ggfinal)


p <- ggarrange(plotlist = plot_list_with_legend, nrow = 2, ncol = ceiling(length(plot_list_with_legend) / 2), labels = toupper(letters[1:5]))

p
```


```{r}
ggsave("./figures/benchmark_ordination_panel.png", device = "png", height = 10, width = 12, plot = p)
```


```{r}
gg_kit_colors <- scale_color_manual(values = kit_colors)
gg_kit_fill <- scale_fill_manual(values = kit_colors)

plot_soil_ord <- function(soil) {
  plotAmpliconOrdinationSoil(ampdata, soil, ord_type = "PCA", envvector = phylum_vector) + gg_kit_colors + gg_kit_fill
}

plot_list <- map(soil, plot_soil_ord)

plot_list2 <- addLegendPlot(plot_list)

p <- ggarrange(plotlist = plot_list2, nrow = 2, ncol = ceiling(length(plot_list) / 2), labels = toupper(letters[1:5]))
p
```
```{r}
ggsave("./figures/benchmark_ordination_panel.png", device = "png", height = 10, width = 12, plot = p)
```


#### Permanova ordination
```{r}
otu <- dat_types_sub10000_ra$abund %>% t()

permanova1 <- adonis2(otu ~ Kit, data = dat_types_sub10000_ra$metadata, permutations = 999, method = "bray", by = "terms")

permanova1 %>%
  rownames_to_column("Variable") %>%
  mutate(across(3:6, ~ round(., digits = 3))) %>%
  gridExtra::tableGrob(rows = NULL) %>%
  gridExtra::grid.arrange(.)

# permanova2 <- adonis2(otu ~ Soil_type, data = dat_types_sub10000_ra$metadata, permutations = 999, method = "bray", by = "terms")

# permanova2 %>%
#   rownames_to_column("Variable") %>%
#   mutate(across(3:6, ~round(., digits = 3))) %>%
#   gridExtra::tableGrob(rows = NULL) %>%
#   gridExtra::grid.arrange(.)

# dist <- vegdist(otu)
# anova(betadisper(dist, dat_types_sub10000_ra$metadata$Kit))
```

# Plotting
```{r}
dummy_table <- ggarrange(alpha_table, NULL, nrow = 2, heights = c(1, 0.035))

p <- ggarrange(dummy_table, NULL, plot.ordinate.insert, ncol = 3, common.legend = T, legend = "bottom", widths = c(1, 0.05, 1), labels = c("A", "B"))

ggsave(here("Benchmarking", "figures", "ordination_CA_table_v2.png"), device = "png", height = 11, width = 15, plot = p)
```

## Gram positive bias

### Heatmap
```{r}
dat_types_sub10000_ra$metadata$Kit <- factor(dat_types_sub10000_ra$metadata$Kit, levels = kit_levels)
```

```{r}
phyla.text <- dat_types_sub10000_ra %>%
  amp_heatmap(
    group_by = c("Kit"),
    tax_aggregate = "Phylum",
    measure = "median",
    tax_show = 7000,
    normalise = FALSE,
    textmap = TRUE
  ) %>%
  mutate(total = rowSums(.)) %>%
  select(total) %>%
  arrange(desc(total)) %>%
  dplyr::slice(1:20) %>%
  rownames(.)

heatmap <- dat_types_sub10000_ra %>%
  amp_heatmap(
    facet_by = "Soil_type",
    group_by = "Kit",
    tax_aggregate = "Phylum",
    # tax_add = c("Phylum"),
    tax_show = phyla.text,
    plot_values = FALSE,
    color_vector = c("salmon", "white", "royalblue4")
  ) +
  labs(
    x = "",
    y = "",
    title = "Heatmap aggregated at the phylum level across kits and sample types"
  ) +
  articletheme +
  theme(
    strip.text.x = element_text(size = 12),
    plot.title = element_text(size = 14)
  )
```
```{r}
ggsave(here("Benchmarking", "figures", "heatmap.png"), plot = heatmap, device = "png", height = 8, width = 12)
```

